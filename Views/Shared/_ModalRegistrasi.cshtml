<div class="modal fade" id="ModalRegistrasi" tabindex="-1" aria-labelledby="LoginModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 border-0">
      <div class="home-cart mt-0">
        <div class="row">
          <!-- Header -->
          <div class="col-12">
            <div class="login-top position-relative text-center bg-primary text-white p-4 rounded-top-4">
              
              <!-- Ilustrasi -->
              <img src="https://cdn-icons-png.flaticon.com/512/2922/2922510.png" 
                  alt="Biodata Illustration" 
                  class="img-fluid mb-3" 
                  style="max-height:40px;">

              <h5 class="fs-4 fw-bold mb-2">Biodata Mitra</h5>
              <p class="fs-7 mb-0 opacity-75 text-white">
                Kami membutuhkan beberapa keterangan tentang Anda, sobat.
              </p>
            </div>
          </div>


          <!-- Body -->
          <div class="col-12">
            <div class="login-bottom p-4">

              <!-- Progress Stepper -->
              <div class="progress mb-4" style="height: 6px;">
                <div id="wizardProgress" class="progress-bar bg-primary" style="width: 0%;"></div>
              </div>

              <!-- Step Content -->
              <div id="stepContent" class="position-relative">

                <!-- Step 1 -->
                <div class="wizard-step" id="step1">
                  <h6 class="fw-bold mb-3 text-primary">Isi Biodata Anda</h6>

                  <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-3" id="namaLengkap" placeholder="Nama Lengkap">
                    <label for="namaLengkap">Nama Lengkap</label>
                  </div>

                  <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-3" id="namaPanggilan" placeholder="Nama Panggilan">
                    <label for="namaPanggilan">Nama Panggilan</label>
                  </div>

                  <div class="form-floating mb-3">
                    <select class="form-select rounded-3" id="jenisKelamin">
                      <option value="" selected disabled>Pilih...</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                    <label for="jenisKelamin">Jenis Kelamin</label>
                  </div>

                  <div class="form-floating mb-3">
                    <input type="date" class="form-control rounded-3" id="tanggalLahir" placeholder="Tanggal Lahir">
                    <label for="tanggalLahir">Tanggal Lahir</label>
                  </div>

                  <div class="d-flex justify-content-end">
                    <button class="btn btn-primary rounded-pill px-4" onclick="nextStep(2)">Lanjut</button>
                  </div>
                </div>

                <!-- Step 2 -->
                <div class="wizard-step d-none" id="step2">
                  <h6 class="fw-bold mb-3 text-primary">Alamat Domisili</h6>

                  <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-3" id="alamat" placeholder="Alamat">
                    <label for="alamat">Alamat</label>
                  </div>

                  <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-3" id="kota" placeholder="Kota">
                    <label for="kota">Kota</label>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevStep(1)">Kembali</button>
                    <button class="btn btn-primary rounded-pill px-4" onclick="nextStep(3)">Lanjut</button>
                  </div>
                </div>

                <!-- Step 3 -->
                <div class="wizard-step d-none" id="step3">
                  <h6 class="fw-bold mb-3 text-primary">Verifikasi WhatsApp</h6>
                  <p class="text-muted">Masukkan nomor WhatsApp aktif Anda, lalu kode verifikasi yang dikirim.</p>

                  <div class="form-floating mb-3">
                    <input type="tel" class="form-control rounded-3" id="noWhatsapp" placeholder="No WhatsApp">
                    <label for="noWhatsapp">No WhatsApp</label>
                  </div>

                  <div class="input-group mb-3">
                    <input type="text" class="form-control rounded-start-3" id="kodeVerifikasi" placeholder="Kode Verifikasi">
                    <button class="btn btn-outline-primary rounded-end-3" type="button" onclick="kirimKode()">Kirim Ulang</button>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevStep(2)">Kembali</button>
                    <button class="btn btn-success rounded-pill px-4" onclick="verifikasiKode()">Verifikasi</button>
                  </div>
                </div>
                <!-- Step 4: Foto Selfie -->
                <div id="step4" class="wizard-step d-none">
                  <div class="text-center mb-4">
                    <h5 class="fw-bold text-primary">Foto Selfie</h5>
                    <p class="text-muted">Ambil foto selfie Anda dengan jelas. Pastikan wajah berada di dalam lingkaran.</p>
                  </div>

                  <div class="camera-section text-center mb-3 position-relative" style="max-width: 100%;">

                    <!-- Video Kamera -->
                    <video id="cameraSelfie" autoplay playsinline class="rounded shadow-sm d-none" style="width:100%;"></video>

                    <!-- Frame Panduan -->
                    <div id="faceFrame" class="position-absolute d-none"
                        style="border: 3px dashed #00cc66; border-radius: 50%; width: 200px; height: 200px;
                              top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">
                    </div>

                    <!-- Tombol Floating -->
                    <button type="button" id="btnTakePhoto"
                      class="btn btn-success rounded-circle shadow position-absolute d-none"
                      style="bottom: 15px; right: 15px; width: 60px; height: 60px; display:flex; align-items:center; justify-content:center;">
                      <i class="bi bi-camera-fill fs-4"></i>
                    </button>

                  </div>

                  <!-- Preview Foto -->
                  <div class="text-center mb-3 position-relative" style="display: inline-block;">
                    <!-- Preview Selfie -->
                    <img id="previewSelfie" 
                        class="img-fluid rounded shadow-sm d-none" 
                        style="max-height:250px;" />

                    <!-- Tombol Retake -->
                    <button type="button" id="btnRetakePhoto"
                      class="btn btn-warning rounded-circle shadow position-absolute d-none"
                      style="bottom: 15px; right: 15px; width: 55px; height: 55px; display:flex; align-items:center; justify-content:center;">
                      <i class="bi bi-arrow-repeat fs-4"></i>
                    </button>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="prevStep(3)">⬅ Kembali</button>
                    <button class="btn btn-primary" onclick="nextStep(5)">Lanjut ➡</button>
                  </div>
                </div>
                <!-- Step 5 -->
                <div class="wizard-step d-none" id="step5">
                  <h6 class="fw-bold mb-3 text-primary">Foto KTP</h6>
                  <p class="text-muted">Unggah foto KTP Anda dengan jelas .</p>

                  <input class="form-control mb-3" type="file" id="uploadSelfie" accept="image/*">

                  <div class="text-center mb-3">
                    <img id="previewSelfie" class="img-fluid rounded shadow-sm d-none" style="max-height:200px;" />
                  </div>

                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevStep(4)">Kembali</button>
                    <button class="btn btn-primary rounded-pill px-4" onclick="nextStep(6)">Lanjut</button>
                  </div>
                </div>

                <!-- Step 6 -->
                <div class="wizard-step d-none" id="step6">
                  <h6 class="fw-bold mb-3 text-primary">Konfirmasi Data</h6>
                  <p class="text-muted">Periksa kembali data Anda sebelum disimpan.</p>
                  <ul class="list-group text-start mb-3">
                    <li class="list-group-item"><strong>Nama Lengkap:</strong> <span id="konfNamaLengkap"></span></li>
                    <li class="list-group-item"><strong>Nama Panggilan:</strong> <span id="konfNamaPanggilan"></span></li>
                    <li class="list-group-item"><strong>No WhatsApp:</strong> <span id="konfNoWhatsapp"></span></li>
                    <li class="list-group-item"><strong>Alamat:</strong> <span id="konfAlamat"></span></li>
                    <li class="list-group-item"><strong>Kota:</strong> <span id="konfKota"></span></li>
                  </ul>
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevStep(5)">Kembali</button>
                    <button class="btn btn-success rounded-pill px-4">Simpan</button>
                  </div>
                </div>

              </div><!-- stepContent -->
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
let video = document.getElementById("cameraSelfie");
let previewImg = document.getElementById("previewSelfie");
let btnTake = document.getElementById("btnTakePhoto");
let btnRetake = document.getElementById("btnRetakePhoto");
let streamTrack = null;

document.addEventListener("DOMContentLoaded", function () {
  // Default tanggal lahir = 15 tahun sebelumnya, 1 Jan
  let today = new Date();
  let defaultYear = today.getFullYear() - 15;
  let defaultDate = `${defaultYear}-01-01`;
  document.getElementById("tanggalLahir").value = defaultDate;
  // Tampilkan step pertama
  nextStep(1, true);
  // Ambil Foto
  btnTake.addEventListener("click", () => {
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    previewImg.src = canvas.toDataURL("image/png");
    previewImg.classList.remove("d-none");

    closeCamera();
    btnRetake.classList.remove("d-none");
  });

  // Ambil Ulang Foto
  btnRetake.addEventListener("click", () => {
    openCamera();
  });
});
// Perbaikan nextStep agar auto buka kamera di step 4
function nextStep(step, first = false) {
  $(".wizard-step").addClass("d-none");
  $("#step" + step).removeClass("d-none");

  let totalSteps = $(".wizard-step").length;
  let percent = (step / totalSteps) * 100;
  $("#wizardProgress").css("width", percent + "%");

  // Jika bukan step 4 → tutup kamera
  if (step !== 4) {
    closeCamera();
  }

  // Jika step 4 → auto buka kamera
  if (step === 4) {
    openCamera();
  }

  // Isi konfirmasi di step 6
  if (step === 6) {
    $("#konfNamaLengkap").text($("#namaLengkap").val());
    $("#konfNamaPanggilan").text($("#namaPanggilan").val());
    $("#konfNoWhatsapp").text($("#noWhatsapp").val());
    $("#konfAlamat").text($("#alamat").val());
    $("#konfKota").text($("#kota").val());
  }
}

function prevStep(step) {
  nextStep(step);
}


function kirimKode() {
  let noWa = $("#noWhatsapp").val();
  if (!noWa) return alert("Masukkan nomor WhatsApp terlebih dahulu.");
  // TODO: API kirim kode
  alert("Kode verifikasi telah dikirim ke " + noWa);
}

function verifikasiKode() {
  let kode = $("#kodeVerifikasi").val();
  if (!kode) return alert("Masukkan kode verifikasi.");
  // TODO: API cek kode
  alert("Verifikasi berhasil!");
  nextStep(4);
}
// Fungsi buka kamera
async function openCamera() {
  try {
    let stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.classList.remove("d-none");
    btnTake.classList.remove("d-none");
    document.getElementById("faceFrame").classList.remove("d-none");

    video.srcObject = stream;
    streamTrack = stream.getTracks()[0];

    // Reset tampilan
    previewImg.classList.add("d-none");
    btnRetake.classList.add("d-none");
  } catch (err) {
    alert("Kamera tidak dapat diakses: " + err.message);
  }
}

// Fungsi tutup kamera
function closeCamera() {
  if (streamTrack) {
    streamTrack.stop();
    streamTrack = null;
  }
  video.classList.add("d-none");
  btnTake.classList.add("d-none");
  document.getElementById("faceFrame").classList.add("d-none");
}
</script>
