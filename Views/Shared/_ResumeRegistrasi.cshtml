<h6 class="fw-bold mb-3 text-primary">âœ… Konfirmasi Data</h6>
<p class="text-muted">Silakan periksa kembali data Anda sebelum disimpan.</p>

<div class="card shadow-sm border-0 rounded-4 mb-3">
  <ul class="list-group list-group-flush" id="listResume"></ul>
</div>

<div class="d-flex justify-content-between">
  <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevStep(5)">
    â¬… Kembali
  </button>
  <button class="btn btn-success rounded-pill px-4" onclick="SimpanMitraDataReg()">
    ðŸ’¾ Simpan
  </button>
</div>

<script>

function ResumeData() {
  var html = `
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-person-fill text-primary me-2"></i><strong>Nama Lengkap</strong></span>
      <span>${$("#namaLengkap").val()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-person-badge-fill text-primary me-2"></i><strong>Nama Panggilan</strong></span>
      <span>${$("#namaPanggilan").val()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-gender-ambiguous text-primary me-2"></i><strong>Jenis Kelamin</strong></span>
      <span>${$("#jenisKelamin").val()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-calendar-event text-primary me-2"></i><strong>Tanggal Lahir</strong></span>
      <span>${$("#tanggalLahir").val()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-geo-alt-fill text-primary me-2"></i><strong>Alamat</strong></span>
      <span class="text-end" style="max-width: 50%;">${$("#alamat").val()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-map text-primary me-2"></i><strong>Koordinat</strong></span>
      <span>${$("#inputMaps").val()}</span>
    </li>
    <li class="list-group-item">
      <i class="bi bi-geo-fill text-primary me-2"></i><strong>Wilayah</strong><br>
      <span class="ms-4 text-muted small">${$("#wilayah").text()}</span>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-whatsapp text-success me-2"></i><strong>No WhatsApp</strong></span>
      <span>${$("#noWhatsapp").val()}</span>
    </li>
    <li class="list-group-item text-center">
      <i class="bi bi-camera-fill text-primary me-2"></i><strong>Foto Selfie</strong><br>
      <img src="${$("#previewSelfie").attr("src")}" class="img-thumbnail mt-2" style="max-height:120px; border-radius:12px;">
    </li>
    <li class="list-group-item text-center">
      <i class="bi bi-credit-card-2-front text-primary me-2"></i><strong>Foto KTP</strong><br>
      <img src="${$("#previewKTP").attr("src")}" class="img-thumbnail mt-2" style="max-height:120px; border-radius:12px;">
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-card-text text-primary me-2"></i><strong>NIK</strong></span>
      <span>${$("#nikInput").val()}</span>
    </li>
  `;
  $("#listResume").html(html);
}

function collectData(_id) {
    let data = {
        id:_id,
        namaLengkap: $("#namaLengkap").val(),
        namaPanggilan: $("#namaPanggilan").val(),
        jenisKelamin: $("#jenisKelamin").val(),
        tanggalLahir: $("#tanggalLahir").val(),
        alamat:
        {
          alamat: $("#alamat").val(),
          koordinat: $("#inputMaps").val(),
          wilayah: $("#wilayah").text()
        },
        noWhatsapp: $("#noWhatsapp").val(),
        nik: $("#nikInput").val().replace(/\s/g, ''), // hapus spasi
        fotoSelfie: $("#previewSelfie").attr("src"), // ambil base64 / url foto
        fotoKTP: $("#previewKTP").attr("src")        // ambil base64 / url foto
  };
  return data;
}

function SimpanMitraDataReg() {
    let _UserId = Storage.get('userId');
    let data = collectData(_UserId);

    Swal.fire({
        title: 'Konfirmasi Simpan',
        text: "Apakah Anda yakin ingin menyimpan data ini?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Simpan',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: "Menyimpan Data...",
                text: "Mohon tunggu sebentar.",
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // proses upload selfie lalu KTP
            uploadSelfie(_UserId)
                .then((resSelfie) => {
                    // tangkap hasil upload selfie
                    data.fotoSelfie = {
                        Id: resSelfie.data.idTask || _UserId,
                        Url: resSelfie.data.url,
                        PublicId: resSelfie.data.publicId
                    };

                    // lanjut upload KTP
                    return uploadKTP(_UserId);
                })
                .then((resKtp) => {
                    // tangkap hasil upload KTP
                    data.fotoKTP = {
                        Id: resKtp.data.idTask || _UserId,
                        Url: resKtp.data.url,
                        PublicId: resKtp.data.publicId
                    };

                    // simpan data akhir
                    return SimpanDataAkhir(data);
                })
                .then(() => {
                    Swal.fire("âœ… Berhasil!", "Data dan foto berhasil disimpan.", "success");
                    window.reload();
                })
                .catch((err) => {
                    console.error(err);
                    Swal.fire("âŒ Gagal!", err || "Terjadi kesalahan saat menyimpan data.", "error");
                });
        }
    });
}

function SimpanDataAkhir(data) {
    return new Promise((resolve, reject) => {
        console.log("Mengirim data akhir:", data);
        callApi({
            url: '/api/Auth/SimpanBiodataMitra',
            method: 'POST',
            data: data, // âœ… pakai data dari parameter
            success: function (res) {
                console.log("Respon simpan biodata:", res);
                resolve(res);
            },
            error: function (err) {
                console.error("Error simpan biodata:", err);
                reject(err);
            },
            onBeforeSend: function () {
                // misal disable tombol simpan
                //$("#btnSimpan").prop("disabled", true).text("Menyimpan...");
            },
            onComplete: function () {
                //$("#btnSimpan").prop("disabled", false).text("ðŸ’¾ Simpan");
            }
        });
    });
}

function uploadSelfie(Id) {
    return new Promise((resolve, reject) => {
        const base64 = $("#previewSelfie").attr("src");
        if (!base64) return reject("Foto Selfie belum diambil.");

        const blob = base64ToBlob(base64);
        const file = new File([blob], "selfie.jpg", { type: blob.type });

        const formData = new FormData();
        formData.append("Id", Id);
        formData.append("File", file);

        callApi({
            url: "/api/Cloudinary/UploadSelfiPhotoRegistrasi",
            method: "POST",
            data: formData,
            contentType: false,
            success: function (res) {
                console.log("Upload selfie berhasil:", res.data);
                resolve(res);
            },
            error: function () {
                reject("Upload foto selfie gagal.");
            }
        });
    });
}

function uploadKTP(Id) {
    return new Promise((resolve, reject) => {
        const base64 = $("#previewKTP").attr("src");
        if (!base64) return reject("Foto KTP belum diambil.");

        const blob = base64ToBlob(base64);
        const file = new File([blob], "ktp.jpg", { type: blob.type });

        const formData = new FormData();
        formData.append("Id", Id);
        formData.append("File", file);

        callApi({
            url: "/api/Cloudinary/UploadKTP",
            method: "POST",
            data: formData,
            contentType: false,
            success: function (res) {
                console.log("Upload KTP berhasil:", res.data);
                resolve(res);
            },
            error: function () {
                reject("Upload foto KTP gagal.");
            }
        });
    });
}
</script>
