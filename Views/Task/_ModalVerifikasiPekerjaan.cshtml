<div class="modal fade" id="ModalVerifikasiPekerjaan" tabindex="-1" aria-labelledby="ModalVerifikasiPekerjaanLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="home-cart mt-0">
                <div class="row">
                <!-- Header -->
                    <div class="col-12">
                        <div class="login-top position-relative text-center bg-primary text-white p-4 rounded-top-4 mb-10">
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                                    data-bs-dismiss="modal" aria-label="Close"></button>
                            <!-- Ilustrasi -->
                            <img src="https://cdn-icons-png.flaticon.com/512/7398/7398228.png"
                                    alt="Verification Illustration"
                                    class="img-fluid mb-3 animate__animated animate__fadeInDown"
                                    style="max-height:40px;">
                            <h6 class="fs-6 fw-bold mb-2">Konfirmasi ke Pelanggan</h6>
                            <p class="text-center text-white">Beritahu Ke Pelanggan bahwa pekerjaan telah selesai</p>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="login-bottom p-4 text-center">
                            <div id="SebelumServices"></div>
                            <div id="SaatPengerjaan"></div>
                            <div id="SetelahServices"></div>
                            <div id="TombolAksi"></div>
                        </div>
                    </div>
                </div>
            </div>  
        </div>
    </div>
</div>


<script>
let Id_VP;
$('#ModalVerifikasiPekerjaan').on('show.bs.modal', function () {
    Id_VP = $(this).data("id");
    // Kalau mau ambil dari tombol pemicu modal:
    if (e.relatedTarget) {
        Id_VP = $(e.relatedTarget).data("id");
    }
    getDataKonfirmasiPekerjaan(Id_VP)
    .then((res)=>{
        console.log(res);
        var satuanMap = {
            suhu: "Â°C",
            tekanan: "PSI",
            ampere: "Amp"
        };
        var list_Sebelum = $.map(res.img_pengukuran_awal, function (item) {
            // mapping Name â†’ key JSON
            let key = "";
            switch (item.Name.toLowerCase()) {
                case "suhu":
                    key = "suhu";
                    break;
                case "tekanan":
                case "tekanan freon":
                    key = "tekanan";
                    break;
                case "ampere":
                    key = "ampere";
                    break;
            }

            // ambil value dari res.pengukuran_awal sesuai key
            let value = key ? res.pengukuran_awal[key] : "";
            let satuan = key ? satuanMap[key] : "";
            var scr = `
                <!-- Card Gambar 1 -->
                <div style="background:#fafafa; padding:2px; border-radius:10px; transition:0.3s; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
                    <img src="${item.Url}" 
                        alt="Foto ${item.Name}" 
                        style="width:100%; max-width:130px; height:110px; object-fit:cover; border-radius:8px;">
                    <div style="margin-top:10px; font-size:14px; font-weight:500; color:#333;">
                        ${item.Name} <br>
                        <span style="font-weight:600; color:#007bff;">${value} ${satuan}</span>
                    </div>
                </div>
            `;
            return scr;
        }).join('');

        var list_saat_pengerjaan = $.map(res.img_pengerjaan, function (item) {
            var scr = `
                <div style="background:#fafafa; padding:12px; border-radius:10px; transition:0.3s; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
                    <img src="${item.Url}" 
                        alt="Foto Pengerjaan" 
                        style="width:100%; max-width:130px; height:110px; object-fit:cover; border-radius:8px;">
                </div>
            `;
            return scr;
        }).join('');

        var list_setelah = $.map(res.img_pengukuran_akhir, function (item) {
            let key = "";
            switch (item.Name.toLowerCase()) {
                case "suhu":
                    key = "suhu";
                    break;
                case "tekanan":
                case "tekanan freon":
                    key = "tekanan";
                    break;
                case "ampere":
                    key = "ampere";
                    break;
            }

            // ambil value dari res.pengukuran_awal sesuai key
            let value = key ? res.pengukuran_awal[key] : "";
            let satuan = key ? satuanMap[key] : "";
            
            var scr = `
                <!-- Card Gambar 1 -->
                <div style="background:#fafafa; padding:2px; border-radius:10px; transition:0.3s; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
                    <img src="${item.Url}" 
                        alt="Foto ${item.Name}" 
                        style="width:100%; max-width:130px; height:110px; object-fit:cover; border-radius:8px;">
                    <div style="margin-top:10px; font-size:14px; font-weight:500; color:#333;">
                        ${item.Name} <br>
                        <span style="font-weight:600; color:#007bff;">${value} ${satuan}</span>
                    </div>
                </div>
            `;
            return scr;
        }).join('');

        var analisis_awal = "";
        if (res?.pengukuran_awal?.indoor?.kondisi =="Normal" && res?.pengukuran_awal?.outdoor?.kondisi =="Normal")  
        {
            analisis_awal = "Normal";
        }
        

        $("#SebelumServices").html(
            `    
                <div style="
                    margin-bottom:20px; 
                    padding:5px; 
                    border-radius:12px; 
                    background:#fff; 
                    box-shadow:0 4px 12px rgba(0,0,0,0.08); 
                    font-family:Arial, sans-serif;
                ">
                    <!-- Header -->
                    <h4 style="
                        margin: 10px 0 20px 0; 
                        font-size:12px; 
                        font-weight:600; 
                        color:#222; 
                        text-align:center; 
                        padding-bottom:10px; 
                        border-bottom:1px solid #eee;
                    ">
                        Pengukuran Sebelum Diservice
                    </h4>

                    <!-- Grid Gambar -->
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; text-align:center;">
                        ${list_Sebelum}
                    </div>

                    <!-- Hasil Pengecekan -->
                    <div style="
                        margin-top:20px; 
                        padding:12px; 
                        text-align:center; 
                        border-radius:8px; 
                        background:#e6f4ea; 
                        color:#2e7d32; 
                        font-size:12px; 
                        font-weight:600;
                    ">
                        Hasil Pengecekan : ${analisis_awal}
                    </div>
                </div>
            `
        );

        $("#SaatPengerjaan").html(`
            <div style="
                margin-bottom:20px; 
                padding:5px; 
                border-radius:12px; 
                background:#fff; 
                box-shadow:0 4px 12px rgba(0,0,0,0.08); 
                font-family:Arial, sans-serif;
            ">
                <!-- Header -->
                <h4 style="
                    margin: 10px 0 20px 0; 
                    font-size:12px; 
                    font-weight:600; 
                    color:#222; 
                    text-align:center; 
                    padding-bottom:10px; 
                    border-bottom:1px solid #eee;
                ">
                    Saat Pengerjaan sesuai Layanan
                </h4>

                <!-- Grid Gambar -->
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; text-align:center;">
                    ${list_saat_pengerjaan}
                </div>
            </div>
        `);

        $("#SetelahServices").html(
        `    
            <div style="
                margin-bottom:20px; 
                padding:5px; 
                border-radius:12px; 
                background:#fff; 
                box-shadow:0 4px 12px rgba(0,0,0,0.08); 
                font-family:Arial, sans-serif;
            ">
                <!-- Header -->
                <h4 style="
                    margin: 10px 0 20px 0; 
                    font-size:12px; 
                    font-weight:600; 
                    color:#222; 
                    text-align:center; 
                    padding-bottom:10px; 
                    border-bottom:1px solid #eee;
                ">
                    Pengukuran Setelah Diservice
                </h4>

                <!-- Grid Gambar -->
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; text-align:center;">
                    ${list_setelah}
                </div>

                <!-- Hasil Pengecekan -->
                <div style="
                    margin-top:20px; 
                    padding:12px; 
                    text-align:center; 
                    border-radius:8px; 
                    background:#e6f4ea; 
                    color:#2e7d32; 
                    font-size:12px; 
                    font-weight:600;
                ">
                    Hasil Pengecekan : Normal
                </div>
            </div>
        `
        );
        let no_wa = res.kontak_pelanggan.nomor.replace(/^\+/, '');
        console.log(no_wa);
        $("#TombolAksi").html(`
            <!-- Tombol aksi -->
            <div class="d-flex flex-column gap-2 py-2">
                <!-- Button Perbaikan -->
                <button onclick=""
                    class="btn btn-warning w-100 rounded-pill text-white shadow-sm d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-tools"></i>
                    <span>Ajukan Perbaikan</span>
                </button>
                <button onclick="kirimKonfirmasiWa('${no_wa}', '${res.encrypted_id}')" 
                    id="btnKonfirmasiWa"
                    class="btn btn-success w-100 rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-whatsapp"></i>
                    <span>Kirim Konfirmasi</span>
                </button>
            </div>
        `);
    })
    .catch((err) => {
        console.error(err);
        Swal.fire("âŒ Gagal!", err || "Terjadi kesalahan saat menyimpan data.", "error");
    });
    console.log(Id_VP);
});

function getDataKonfirmasiPekerjaan(id) {
    return new Promise((resolve, reject) => {
        callApi({
            url: '/api/Task/GetDataKonfirmasiPekerjaan?Id='+id,
            method: 'GET',
            //data: data, // âœ… pakai data dari parameter
            success: function (res) {
                //console.log("Respon get data:", res);
                resolve(res);
            },
            error: function (err) {
                console.error("Error get data:", err);
                reject(err);
            },
            onBeforeSend: function () {
                // misal disable tombol simpan
                $("#SebelumServices").html(`
                    <div class="p-3 mb-2 border rounded shadow-sm">
                        <div class="d-flex align-items-center mb-2">
                        <div class="skeleton-icon me-2"></div>
                        <div class="skeleton-text w-50"></div>
                        </div>
                        <div class="skeleton-text w-75 mb-1"></div>
                        <div class="skeleton-text w-25"></div>
                    </div>
                `);
            },
            onComplete: function () {
                //$("#btnSimpan").prop("disabled", false).text("ðŸ’¾ Simpan");
            }
        });
    });
}

function kirimKonfirmasiWa(no_hp, idTask) {
    // pesan konfirmasi
    const pesan = 
    `Halo, ini konfirmasi pengerjaan untuk Task ID: #ACD-${formatToSixDigits(idTask)}.\n\n` +
    `Silakan cek detail lebih lanjut di link berikut:\n` +
    `https://customer.dikariapp/konfirmasi/${idTask}\n`+
    `atau buka applikasi :\n`+
    `https://play.google.com/store/apps/details?id=com.dikariapp.customer.twa`;

    // encode pesan agar aman dipakai di URL
    const encodedPesan = encodeURIComponent(pesan);

    // arahkan ke WhatsApp
    window.open(`https://wa.me/${no_hp}?text=${encodedPesan}`, '_blank');
  }
</script>