<div class="modal fade" id="ModalDalamPerjalanan" tabindex="-1" aria-labelledby="ModalDalamPerjalananLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 border-0 shadow-lg">
      <div class="home-cart mt-0">
        <div class="row">
          <!-- Header -->
            <div class="col-12">
                <div class="login-top position-relative text-center bg-gradient-primary text-white p-4 rounded-top-4 shadow-sm">
                    <!-- Tombol Close -->
                    <button type="button" 
                            class="btn btn-light btn-sm position-absolute top-0 end-0 m-3 rounded-circle shadow-sm"
                            data-bs-dismiss="modal" aria-label="Close"
                            style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;">
                        <i class="bi bi-x-lg text-primary"></i>
                    </button>

                    <!-- Ilustrasi -->
                    <div class="d-flex justify-content-center mb-3">
                        <img src="https://cdn-icons-png.flaticon.com/512/7398/7398228.png"
                            alt="Verification Illustration"
                            class="img-fluid animate__animated animate__fadeInDown"
                            style="max-height:50px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
                    </div>

                    <!-- Judul -->
                    <h5 class="fw-semibold mb-0" style="font-size:1.1rem; letter-spacing:0.3px;">
                        Teknisi Sedang Dalam Perjalanan
                    </h5>
                    <p class="text-white-50 mt-1 mb-0" style="font-size:0.85rem;">
                        Mohon bersiap di lokasi, teknisi segera tiba.
                    </p>
                </div>
            </div>


            <div class="col-12">
                <div class="login-bottom p-4 text-center">
                    <div id="otw">
                        <div style="margin-bottom:10px;">
                            <img src="https://res.cloudinary.com/dfdjjuhr0/image/upload/v1759160957/scooter-4657_256_jyblah.gif" 
                                alt="Processing Icon" 
                                class="img-fluid mb-3" 
                                style="max-height:200px;">
                            <h6 class="fw-bold">Sedang Dalam Perjalanan</h6>
                            <p class="mb-0 text-muted small">
                                Kamu sedang menuju lokasi pelanggan.  
                                Segera hubungi atau konfirmasi jika sudah sampai.
                            </p>
                        </div>

                        <!-- Tombol Aksi (Modern & Minimalis) -->
                        <div class="d-flex justify-content-center flex-wrap gap-2 py-2">

                            <button onclick="showMapsTujuan()" 
                                class="btn btn-light border d-flex align-items-center gap-1 px-3 shadow-sm">
                                <i class="bi bi-geo-alt-fill text-primary"></i>
                                <span class="fw-semibold">Maps</span>
                            </button>

                            <button onclick="callCustomer();" 
                                class="btn btn-light border d-flex align-items-center gap-1 px-3 shadow-sm">
                                <i class="bi bi-telephone-fill text-warning"></i>
                                <span class="fw-semibold text-dark">Call</span>
                            </button>

                            <button onclick="sendMessage();" 
                                class="btn btn-light border d-flex align-items-center gap-1 px-3 shadow-sm">
                                <i class="bi bi-whatsapp text-success"></i>
                                <span class="fw-semibold text-dark">WA</span>
                            </button>

                            <button onclick="showModaFotoUnit();" id="btnSudahSampai"
                                class="btn btn-primary text-white d-flex align-items-center gap-1 px-3 shadow-sm">
                                <i class="bi bi-check-circle-fill"></i>
                                <span class="fw-semibold">Sudah Sampai</span>
                            </button>

                        </div>

                    </div>
                </div>
            </div>
        </div>
      </div>  
    </div>
  </div>
</div>

<script>
let IdTask_OTW;
let origin;
let nohp;


$('#ModalDalamPerjalanan').on('show.bs.modal', function (e) {
    IdTask_OTW = $(this).data("id");
    id_pelanggan = $(this).data("id_pelanggan");
    origin = $(this).data("origin");
    nohp = $(this).data("nohp");

    if (e.relatedTarget) {
        IdTask_OTW = $(e.relatedTarget).data("id");
        origin = $(e.relatedTarget).data("origin");
        nohp = $(e.relatedTarget).data("nohp");
    }
    console.log("Origin:", origin);
    console.log("nohp:", nohp);
});

function showMapsTujuan(){
    console.log(origin);
    let url = `https://www.google.com/maps/dir/?api=1&destination=${origin}&travelmode=driving`;
    window.open(url, '_blank');
}

function callCustomer(){
    let telUrl = `tel:${nohp}`;
    window.open(telUrl, '_self');
}

function sendMessage() {
    
    // Hapus tanda + di nomor agar bisa digunakan di wa.me
    const nomor = nohp.replace("+", "").trim();

    // Buat pesan otomatis
    const pesan = `
Halo , saya dari Mitra ACD.
    `.trim();

    // Encode agar aman untuk URL
    const encodedMessage = encodeURIComponent(pesan);

    // Buat link WhatsApp
    const waUrl = `https://wa.me/${nomor}?text=${encodedMessage}`;

    // Buka WhatsApp di tab baru
    window.open(waUrl, '_blank');
}

function showModaFotoUnit(){

    let _UserId = Storage.get('userId');
    var data =
    {
        Id : IdTask_OTW,
        MitraId : _UserId
    }

    UpdateTeknisiSampaiLokasi(data)
    .then((res) => {
        if(res){
            callUpdateStatusPadaPelanggan(id_pelanggan,"teknisi telah tiba di lokasi");
            LoadListTask(hari,status);
            $("#ShowCamera").attr("data-id", IdTask_OTW); // simpan id ke attribute modal    
            $("#ShowCamera").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ShowCamera").modal("show");
            $("#ModalDalamPerjalanan").modal("hide");
        }
        else
        {
            showToast(res.message);
        }
    }).
    catch((err) => {
        console.error(err);
        Swal.fire("❌ Gagal!", err || "Terjadi kesalahan saat menyimpan data.", "error");
    });
}

function UpdateTeknisiSampaiLokasi(data) {
    return new Promise((resolve, reject) => {
        callApi({
            url: '/api/Task/SampaiDiLokasi',
            method: 'POST',
            data: data, // ✅ pakai data dari parameter
            success: function (res) {
                console.log("Respon simpan biodata:", res);
                resolve(res);
            },
            error: function (err) {
                console.error("Error simpan biodata:", err);
                $("#btnSudahSampai").prop("disabled", false).text("Sudah Sampai");
                reject(err);
            },
            onBeforeSend: function () {
                $("#btnSudahSampai").prop("disabled", true).text("Memproses...");
            },
            onComplete: function () {
                $("#btnSudahSampai").prop("disabled", false).text("Sudah Sampai");
            }
        });
    });
}

</script>
