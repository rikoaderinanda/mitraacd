<style>
    .modal.fade .modal-dialog {
        transition: transform 0.8s cubic-bezier(.4, 0, .2, 1), opacity 0.3s cubic-bezier(.4, 0, .2, 1);
        transform: translateY(40px) scale(0.98);
        opacity: 0;
    }

    .modal.fade.show .modal-dialog {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    #previewContainer_PFT img {
        transition: transform 0.3s ease;
    }

    #previewContainer_PFT img:hover {
        transform: scale(1.05);
        cursor: pointer;
    }

    .camera-actions {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 10;
    }

    .camera-actions button {
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="modal fade" id="ModalPengerjaanPhoto" tabindex="-1" aria-labelledby="ModalPengerjaanPhotoLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content shadow-lg border-0 rounded-4">
      
      <!-- Header Gradient Merah -->
      <div class="modal-header text-white rounded-top-4" style="background: linear-gradient(135deg, #d63031, #c0392b);">
        <h5 class="modal-title" id="ModalPengerjaanPhotoLabel">
          <i class="bi bi-camera-video me-2"></i>  Foto aktifitas Pengerjaan
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
        <div class="modal-body p-4 bg-light">
            <div class="text-center mb-3">
                <p class="fs-6 fw-semibold text-dark">
                ðŸ“· Silakan ambil Foto saat aktifitas pengerjaan layanan
                </p>
            </div>
            <!-- Preview Foto -->
            <div class="row g-3 mt-0 mb-2" id="previewContainer_PFT">
                <!-- Foto 1 -->
                <div class="col-4 text-center" id="can1">
                    <div class="border rounded-3 p-0 shadow-sm position-relative bg-white">
                        <h6 class="fw-semibold small text-primary mb-2 mt-2 p-1">1. Indoor</h6>
                        <img id="photo_PFT1" class="img-fluid rounded mb-0 preview-photo" data-index="1" style="display: none; max-height: 100px; object-fit: cover; cursor: pointer;" />
                        <button id="redo1" class="btn btn-sm btn-outline-danger rounded-pill mt-1 small w-100" style="display: none;" onclick="redoPhoto_PFT(1)">
                            <i class="bi bi-arrow-clockwise me-1"></i> Ulangi
                        </button>
                    </div>
                </div>

                <!-- Foto 2 -->
                <div class="col-4 text-center" id="can2">
                    <div class="border rounded-3 p-0 shadow-sm position-relative bg-white">
                        <h6 class="fw-semibold small text-primary mb-2 mt-2 p-1">2. Outdoor</h6>
                        <img id="photo_PFT2" class="img-fluid rounded mb-0 preview-photo" data-index="2" style="display: none; max-height: 100px; object-fit: cover; cursor: pointer;" />
                        <button id="redo2" class="btn btn-sm btn-outline-danger rounded-pill mt-1 small w-100" style="display: none;" onclick="redoPhoto_PFT(2)">
                            <i class="bi bi-arrow-clockwise me-1"></i> Ulangi
                        </button>
                    </div>
                </div>

                <!-- Foto 3 -->
                <div class="col-4 text-center" id="can3">
                    <div class="border rounded-3 p-0 shadow-sm position-relative bg-white">
                        <h6 class="fw-semibold small text-primary mb-2 mt-2 p-1">3. Hasil 5S</h6>
                        <img id="photo_PFT3" class="img-fluid rounded mb-0 preview-photo" data-index="3" style="display: none; max-height: 100px; object-fit: cover; cursor: pointer;" />
                        <button id="redo3" class="btn btn-sm btn-outline-danger rounded-pill mt-1 small w-100" style="display: none;" onclick="redoPhoto_PFT(3)">
                            <i class="bi bi-arrow-clockwise me-1"></i> Ulangi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Area Kamera -->
            <div class="rounded-3 overflow-hidden shadow-sm mb-3" style="border: 2px dashed #d63031;" id="panelCamera_PFT">
                <video id="videoPreview_PFT" autoplay playsinline width="100%" height="auto"></video>
                <canvas id="canvasPhoto_PFT" style="display: none;"></canvas>
                <div class="camera-actions">
                    <button class="btn btn-primary rounded-circle shadow" onclick="switchCamera_PFT()" title="Ganti Kamera">
                        <i class="bi bi-arrow-repeat fs-5"></i>
                    </button>
                    <button class="btn btn-danger rounded-circle shadow" onclick="capturePhoto_PFT()" title="Ambil Foto">
                        <i class="bi bi-camera fs-4"></i>
                    </button>
                </div>
            </div>

            <div id="panelInputPekerjaan_PFT" class="d-none">
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-success px-4 rounded-pill" onclick="ProsesAktifitas()">
                        <i class="bi bi-send-fill me-2"></i> Submit Aktifitas
                    </button>
                </div>
            </div>
        </div>
    
    </div>
  </div>
</div>

<script>
let Id_PFT;

let currentFacingMode_PFT = 'environment';
let cameraStream_PFT = null;
let video_PFT = document.getElementById('videoPreview_PFT');
let canvas_PFT = document.getElementById('canvasPhoto_PFT');
let currentPhotoIndex_PFT = 1;
const maxPhotos_PFT = 3;
let photoTaken_PFT = [false, false, false];


$('#ModalPengerjaanPhoto').on('hidden.bs.modal', function () {
    $("#panelCamera_PFT").removeClass("d-none");
    $("#panelInputPekerjaan_PFT").addClass("d-none");
    stopCamera_PFT();
    resetPhotos_PFT();
});

$('#ModalPengerjaanPhoto').on('show.bs.modal', function (e) {
    $("#panelCamera_PFT").removeClass("d-none");
    $("#panelInputPekerjaan_PFT").addClass("d-none");
    Id_PFT = $(this).data("id");
    id_pelanggan = $(this).data("id_pelanggan");
    if (e.relatedTarget) {
        Id_PFT = $(e.relatedTarget).data("id");
    }

    Swal.fire({
        title: 'Mengaktifkan Kamera',
        html: '<i class="fas fa-spinner fa-spin fa-2x" style="color:#3085d6;"></i><p>Mohon tunggu sebentar...</p>',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    stopCamera_PFT();
    currentFacingMode_PFT = currentFacingMode_PFT === 'user' ? 'environment' : 'user';

    startCamera_PFT(Id_PFT)
        .then(() => Swal.close())
        .catch(err => {
            Swal.fire('Error', 'Gagal mengaktifkan kamera: ' + err.message, 'error');
        });
});


$('.preview-photo').on('click', function () {
    var index = $(this).data('index');
    // Sembunyikan semua tombol dulu
    $('[id^=redo]').hide();

    // Tampilkan tombol hanya untuk yang diklik
    $('#redo' + index).show();
});
// Jika klik di luar elemen gambar preview, sembunyikan semua tombol ulangi
$(document).on('click', function () {
    $('[id^=redo]').hide();
});

// Cegah klik tombol "Ulangi" juga tidak dianggap klik luar
$('[id^=can]').on('click', function (e) {
    e.stopPropagation();
});


function switchCamera_PFT() {
  stopCamera_PFT(); // Hentikan kamera aktif
  currentFacingMode_PFT = currentFacingMode_PFT === 'user' ? 'environment' : 'user'; // toggle
  startCamera_PFT(Id_SC); // Mulai kamera lagi
}

function startCamera_PFT(Id) {
  return navigator.mediaDevices.getUserMedia({
    video: { facingMode: currentFacingMode_PFT }
  })
    .then(function (stream) {
      cameraStream_PFT = stream;
      video_PFT.srcObject = stream;
      return stream; // return supaya .then di luar bisa dipanggil
    })
    .catch(function (err) {
      console.error("Gagal mengakses kamera:", err);
      throw err; // biar bisa ditangkap di .catch luar
    });
}

function stopCamera_PFT() {
  if (cameraStream_PFT) {
    cameraStream_PFT.getTracks().forEach(track => track.stop());
    cameraStream_PFT = null;
  }
}

function capturePhoto_PFT() {
  if (currentPhotoIndex_PFT > maxPhotos_PFT) {
    ProsesAktifitas();
  }
  
  let context_PFT = canvas_PFT.getContext('2d');
  canvas_PFT.width = video_PFT.videoWidth;
  canvas_PFT.height = video_PFT.videoHeight;
  context_PFT.drawImage(video_PFT, 0, 0, canvas_PFT.width, canvas_PFT.height);
  let imageData_PFT = canvas_PFT.toDataURL('image/png');

  $(`#photo_PFT${currentPhotoIndex_PFT}`).attr('src', imageData_PFT).show();
  $(`#photo_PFT${currentPhotoIndex_PFT}`).next('button').hide();
  photoTaken_PFT[currentPhotoIndex_PFT - 1] = true;
  
  for (let i = 1; i <= maxPhotos_PFT; i++) {
    if (!photoTaken_PFT[i - 1]) {
      currentPhotoIndex_PFT = i;
      return;
    }
  }

  currentPhotoIndex_PFT = maxPhotos_PFT + 1;
  
  if (currentPhotoIndex_PFT > maxPhotos_PFT) {
    InputHasilPekerjaan();
  }
}
function InputHasilPekerjaan(){
    $("#panelCamera_PFT").addClass("d-none");
    $("#panelInputPekerjaan_PFT").removeClass("d-none");
}

function ProsesAktifitas(){
    stopCamera_PFT()
    Swal.fire({
          title: '<strong>ðŸ“¸ Aktifitas sudah difoto !</strong>',
          html: `
              <div style="font-size: 15px; color: #555;">
                  Semua <b> Aktifitas </b> telah didokumentasikan.<br>
                  Apakah kamu ingin melanjutkan ke <b>Tahap QC</b>?
              </div>
          `,
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: '<i class="bi bi-check-circle-fill"></i> Iya, lanjut',
          cancelButtonText: '<i class="bi bi-arrow-clockwise"></i> Batal',
          reverseButtons: true,
          background: '#f9f9f9',
          
          customClass: {
              popup: 'shadow rounded-4',
              confirmButton: 'btn btn-success rounded-pill px-4 py-2 mx-2',
              cancelButton: 'btn btn-outline-danger rounded-pill px-4 py-2 mx-2'
          },
          buttonsStyling: false
      }).then((result) => {
          if (result.isConfirmed) {
              lanjutPengerjaan();
          } 
      });
}

function lanjutPengerjaan(){
    const formData = new FormData();
    for (let i = 1; i <= 3; i++) {
        const img = document.getElementById(`photo_PFT${i}`);
        if (img && img.style.display !== 'none' && img.src.startsWith('data:image')) {
            const blob = dataURLToBlob(img.src);
            formData.append('imageFiles', blob, `photo_PFT${i}.jpg`);
        }
    }

    if (!formData.has('imageFiles')) {
        Swal.fire('Gagal', 'Tidak ada gambar yang dipilih.', 'warning');
        return;
    }
    
    formData.append('IdTask', Id_PFT);

    callApi({
        url: '/api/Cloudinary/PhotoPekerjaanUpload',
        method: 'POST',
        data: formData,
        success: function (res) {
          //console.log(res);
          if(res.success){
              LoadListTask(hari,status);
              $("#ModalPengecekanAkhir").attr("data-id", Id_PFT);
              $("#ModalPengecekanAkhir").attr("data-id_pelanggan", id_pelanggan);
              $("#ModalPengecekanAkhir").modal("show");
              $('#ModalPengerjaanPhoto').modal('hide');
              
          }
          else
          {
            showToast(res.message);
          }
          
        },
        error: function (err) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Gagal memperbarui task: ' + err
            });
        },
        onBeforeSend: function () {
            Swal.fire({
              title: '<div style="font-size: 20px; font-weight: 600;">Mengunggah Dokumentasi Pekerjaan</div>',
              html: `
                <div style="display: flex; flex-direction: column; align-items: center;">
                  <div class="spinner" style="margin-bottom: 15px;">
                    <i class="fas fa-spinner fa-spin fa-3x" style="color: #3085d6;"></i>
                  </div>
                  <p style="font-size: 14px; color: #555;">Mohon tunggu sebentar, sistem sedang memproses foto Anda...</p>
                </div>
              `,
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              background: '#fff',
              customClass: {
                popup: 'swal2-border-radius',
              },
              didOpen: () => {
                Swal.showLoading();
              }
            });
        },
        onComplete: function () {
            Swal.close();
        }
    });
}


function redoPhoto_PFT(index) {
  $("#panelCamera_PFT").removeClass("d-none");
  $("#panelInputPekerjaan_PFT").addClass("d-none");
  
  photoTaken_PFT[index - 1] = false;
  currentPhotoIndex_PFT = index;
  $(`#photo${index}`).attr('src', '').hide();
  $(`#photo${index}`).next('button').hide();

  for (let i = 1; i <= maxPhotos_PFT; i++) {
    if (!photoTaken_PFT[i - 1]) {
      currentPhotoIndex_PFT = i;
      return;
    }
  }
}

function resetPhotos_PFT() {
  currentPhotoIndex_PFT = 1;
  photoTaken_PFT = [false, false, false, false, false];
  for (let i = 1; i <= maxPhotos_PFT; i++) {
    $(`#photo_PFT${i}`).attr('src', '').hide();
    $(`#photo_PFT${i}`).next('button').hide();
  }
}
</script>