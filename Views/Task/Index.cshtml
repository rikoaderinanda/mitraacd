@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Home Page";
    var baseApiUrl = Configuration["AppConfig:BaseApiUrl"];
}
<script>
    // Variabel global yang dapat diakses oleh semua skrip
    const BASE_API_URL = '@baseApiUrl';
</script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    .hover-shadow:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08) !important;
        transition: box-shadow 0.3s ease-in-out;
    }

    .card-footer .overflow-auto::-webkit-scrollbar {
        height: 6px;
    }

    .card-footer .overflow-auto::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
</style>
<style>
    /* Animasi shimmer */
    @@keyframes skeleton-loading {
    0% {
        background-position: -200px 0;
    }
    100% {
        background-position: 200px 0;
    }
    }

    /* Base skeleton style */
    .skeleton-text,
    .skeleton-icon {
    background: linear-gradient(90deg, #e0e0e0 25%, #f2f2f2 50%, #e0e0e0 75%);
    background-size: 400% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
    }

    .skeleton-text {
    height: 14px;
    }

    .skeleton-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    }

    /* Minimalist Modern Tabs */
    .modern-tabs {
    display: flex;
    width: 100%;
    border-bottom: none !important;
    }

    .modern-tabs .nav-item {
    flex: 1;
    text-align: center;
    }

    .modern-tabs .nav-link {
    width: 100%;
    border: none;
    border-radius: 0;
    padding: 12px 0 8px;
    font-weight: 500;
    font-size: 0.85rem;
    color: #666;
    background: transparent;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    }

    .modern-tabs .nav-link i {
    font-size: 1.3rem;
    }

    .modern-tabs .nav-link:hover {
    color: #0d6efd;
    background: rgba(13,110,253,0.05);
    }

    .modern-tabs .nav-link.active {
    color: #0d6efd;
    border-bottom: 3px solid #0d6efd;
    background: transparent;
    font-weight: 600;
    }

    /* Tab Content */
    .tab-content {
    font-size: 0.95rem;
    line-height: 1.6;
    background: #fff;
    border-radius: 12px;
    @* box-shadow: 0 2px 8px rgba(0,0,0,0.08); *@
    margin-top: 10px;
    @* padding: 20px; *@

    }

    .card-service {
    margin-bottom: 10px;
    @* padding: 16px; *@
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    font-family: "Segoe UI", Arial, sans-serif;
    }

    .card-service h4 {
    margin: 0 0 16px 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    text-align: center;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
    }

    .card-service .grid-images {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    text-align: center;
    }

    .card-service .grid-images img {
    width: 100%;
    border-radius: 10px;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
    }

    .card-service .grid-images img:hover {
    transform: scale(1.05);
    }

    .card-service .result {
    margin-top: 20px;
    padding: 12px;
    text-align: center;
    border-radius: 10px;
    background: #e8f5e9;
    color: #2e7d32;
    font-size: 13px;
    font-weight: 600;
    }
     /* Style default tombol */
    .jadwal-btn {
        transition: all 0.3s ease;
        border: none;
    }

    /* Style saat tombol dipilih (active) */
    .jadwal-btn.active {
        transform: scale(1.05);
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        border: 2px solid rgba(255, 255, 255, 0.6);
    }
</style>

@await Html.PartialAsync("_ModalVerifikasiPekerjaan")
@await Html.PartialAsync("_ModalPengecekanAkhir")
@await Html.PartialAsync("_ModalPengerjaanPhoto")
@await Html.PartialAsync("_ModalDalamPerjalanan")
@await Html.PartialAsync("_ModalShowCamera")

<div class="app-body pb-30">    
    <div class="container" style="margin-top:10px;margin-bottom :10px;">
        <div class="owl-carousel" id="jadwalCarousel" style="margin-top:10px;margin-bottom:10px;">
            <!-- Hari Ini -->
            <div class="item">
                <button id="btnHariIni" 
                        class="btn btn-sm w-100 rounded-pill jadwal-btn"
                        onclick="setActiveBtn(this); LoadListTask(0,status);"
                        style="background: #007bff; color:#fff;">
                    <i class="bi bi-calendar-day me-1"></i> Hari Ini
                </button>
            </div>
            <!-- Besok -->
            <div class="item">
                <button id="btnHariBesok" 
                        class="btn btn-sm w-100 rounded-pill jadwal-btn"
                        onclick="setActiveBtn(this); LoadListTask(1,status);"
                        style="background: #ffc107; color:#000;">
                    <i class="bi bi-calendar-check me-1"></i> Besok
                </button>
            </div>
            <!-- Jauh Hari -->
            <div class="item">
                <button id="btnHariJauh" 
                        class="btn btn-sm w-100 rounded-pill jadwal-btn"
                        onclick="setActiveBtn(this); LoadListTask(2,status);"
                        style="background: #28a745; color:#fff;">
                    <i class="bi bi-calendar-range me-1"></i> Jauh Hari
                </button>
            </div>
        </div>

            <ul class="nav nav-tabs modern-tabs" id="serviceTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sebelum-tab" data-bs-toggle="tab" type="button" role="tab" onclick="LoadListTask(hari,4)">
                    <i class="bi bi-hourglass-split"></i>
                    <span>On Schedule</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="saat-tab" data-bs-toggle="tab" type="button" role="tab" onclick="LoadListTask(hari,5)">
                    <i class="bi bi-tools"></i>
                    <span>On Progress</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="setelah-tab" data-bs-toggle="tab" type="button" role="tab" onclick="LoadListTask(hari,10)">
                    <i class="bi bi-check-circle"></i>
                    <span>Finished</span>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="serviceTabsContent">
                <div id="ListTask">
                </div>
            </div>
        
    </div>
</div>

<script>
    let hari = 0;
    let status = 4;
    var $;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.jQuery === 'undefined') {
            console.error('jQuery is not loaded.');
            return;
        }
        $ = window.jQuery;
        Storage.set("CurrentPage","");
        
        loadHeader();
        checkStatusMitra().then(result => {
            if (result.data.status_mitra == 5) 
            {
                const defaultTab = document.querySelector("#sebelum-tab");

                // Tambahkan kelas active ke tab dan parent <li>
                defaultTab.classList.add("active");
                defaultTab.closest(".nav-item").classList.add("active");
                LoadListTask(hari,status);
                initFilter();
                document.getElementById("btnHariIni").classList.add("active");
            }
            else{
                Swal.fire({
                    title: "Akun Belum Aktif",
                    text: "Akun Mitra Anda belum aktif sepenuhnya. Silakan ikuti langkah aktivasi terlebih dahulu.",
                    icon: "info",
                    confirmButtonColor: "#198754",
                    confirmButtonText: "Ikuti Aktivasi",
                    timer: 6000,
                    timerProgressBar: true
                }).then(() => {
                    window.location.href = '@Url.Action("Index","Home")';
                });
            }
        });
    });

    function setActiveBtn(btn) {
        // Hapus active di semua tombol
        document.querySelectorAll(".jadwal-btn").forEach(el => el.classList.remove("active"));
        // Tambahkan active di tombol yang diklik
        btn.classList.add("active");
    }

    function initFilter() {
        $('#jadwalCarousel').owlCarousel({
            loop: false,
            margin: 2,
            nav: false,
            responsive: {
                0: { items: 3 },
                600: { items: 3 },
                1000: { items: 3 }
            }
        });
    }

    function LoadListTask(_hari,_status){
        let _UserId = Storage.get('userId');
        callApi({
            url: '/api/Task/GetTask?Id='+_UserId+'&Hari='+_hari+'&status='+_status,
            method: 'GET',
            success: function (data) {
                hari = _hari;
                status = _status;
                //console.log(data);
                var html = "";
                if (!data || data.length === 0) {
                    html = '<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>';
                    $('#ListTask').html(html);
                }
                else {
                    
                    html = $.map(data, function (item) {
                        var tglKunjung = "";
                        var jamKunjung = "";
                        if(item.jenis_layanan=="REG"){
                            tglKunjung = item.kunjungan.reguler.tanggal;
                            jamKunjung = item.kunjungan.reguler.jam;
                        }

                        let no_plgn = item.kontak_pelanggan.nomor.replace("+", "");
                        let btnAction ="";
                        
                        btnAction = btnAction + `
                            <!-- Tombol Aksi -->
                            <button onclick="DetailPesanan(289,'btnDetail289');"
                                    class="btn btn-sm btn-primary rounded-pill px-3">
                                    Detail <i class="bi bi-arrow-right-short"></i>
                            </button>
                        `;

                        let alertDurasi = "";
                        if(item.status == 3)
                        {
                            alertDurasi = `
                                <div class="alert alert-warning small py-2 mb-2 rounded-3 d-none" id="SLA_${item.id}">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                    Sesuai waktu kunjungan dan estimasi perjalanan, kemungkinan kamu akan <b>terlambat</b>.
                                    Segera hubungi pelanggan untuk konfirmasi keterlambatan.
                                </div> 
                            `;
                        }

                        if(item.status == 4 && hari == 0){
                            btnAction = btnAction + `
                                <button onclick="TaskStart(${item.id},${item.id_pelanggan});" id="btnStart${item.id}"
                                        class="btn btn-sm btn-success rounded-pill px-3">
                                        Mulai <i class="bi bi-arrow-right-short"></i>
                                </button>
                            
                            `;
                        }

                        if(item.status > 4 && item.status < 9 && hari == 0){
                            btnAction = btnAction + `
                                <button onclick="showProcess(${item.id},${item.status},${item.id_pelanggan});" id="btnProses${item.id}"
                                        class="btn btn-sm btn-success rounded-pill px-3">
                                        On Progres<i class="bi bi-arrow-right-short"></i>
                                </button>
                            `;
                        }

                        if(item.status == 9){
                            btnAction = btnAction + `
                                <button onclick="showProcess(${item.id},${item.status},${item.id_pelanggan});" id="btnProses${item.id}"
                                        class="btn btn-sm btn-success rounded-pill px-3">
                                        Konfirmasi<i class="bi bi-arrow-right-short"></i>
                                </button>
                            `;
                        }
                       
                        var src = `
                            <div class="card mb-3 border-0 shadow rounded-4 order-card">
                                <div class="card-body p-3">
                                    <!-- Header -->
                                    ${alertDurasi}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="fw-bold text-primary mb-0">ACD-${formatToSixDigits(item.id)}</h6>
                                        <span class="badge bg-light text-primary border">
                                            ${item.kategori_layanan} - ${item.jenis_layanan}
                                        </span>
                                    </div>

                                    <!-- Info Grid -->
                                    <div class="row g-2 small">
                                        <!-- Customer -->
                                        <div class="col-8 d-flex align-items-center">
                                            <i class="bi bi-calendar-event me-1 text-primary"></i>
                                            <span><strong>${formatTanggal(tglKunjung)}</strong> - <strong>${jamKunjung}</strong></span>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span class="text-success text-decoration-none" id="count_${item.id}">--</span>
                                        </div>
                                        <!-- Customer -->
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="bi bi-person-circle text-secondary me-2"></i>
                                            <span class="fw-semibold">${item.kontak_pelanggan.nama}</span>
                                        </div>
                                        <div class="col-6 text-end">
                                            <a href="https://wa.me/${no_plgn}" target="_blank" class="text-success text-decoration-none">
                                                <i class="bi bi-whatsapp me-1"></i>Chat
                                            </a>
                                        </div>

                                        <!-- Lokasi -->
                                        <div class="col-8 d-flex align-items-center flex-wrap">
                                            <!-- Jenis Properti -->
                                            <div class="d-flex align-items-center me-3 mb-1">
                                                <i class="bi bi-house-door-fill text-danger me-1"></i>
                                                <span class="fw-semibold">${item.jenis_properti.nama_jenis}</span>
                                            </div>

                                            <!-- Alamat -->
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="text-muted">${item.alamat_pelanggan.alamat}</span>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <a href="#" target="_blank" class="text-success text-decoration-none"
                                                onclick="showMaps('${item.alamat_pelanggan.koordinat}')"
                                            >
                                                <i class="bi bi-geo me-1"></i>maps
                                            </a>
                                        </div>

                                        <!-- Jarak & Fee -->
                                        <div class="col-6 d-flex align-items-center small text-secondary">
                                            <!-- Jarak -->
                                            <div class="d-flex align-items-center me-3">
                                                <i class="bi bi-signpost text-primary me-1"></i>
                                                <span id="jarak_${item.id}" class="fw-semibold text-dark">--</span>
                                            </div>

                                            <!-- Durasi -->
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-stopwatch text-success me-1"></i>
                                                <span id="durasi_${item.id}" class="fw-semibold text-dark">--</span>
                                            </div>
                                        </div>
                                        <div class="col-6 text-end fw-semibold text-success">
                                            ${formatRupiah(item.fee_teknisi)}
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 mt-3">
                                        ${btnAction}
                                    </div>
                                </div>
                            </div>
                        `;
                        return src;
                    }).join('');
                        
                    $('#ListTask').html(html);

                    // setelah DOM sudah jadi baru panggil countdown & jarak
                    if(data.length > 0){
                        data.forEach(item => {
                            let jamKunjung = item.kunjungan?.reguler?.jam ?? null;
                            if(jamKunjung) {
                                startCountdown(item.id,jamKunjung,"count_"+item.id);
                            }

                            hitungJarakJalan(item.origin, item.tujuan)
                            .then(res => {
                                $("#jarak_"+item.id).text(res.distance);
                                $("#durasi_"+item.id).text(res.duration);
                            })
                            .catch(err => console.error("Gagal hitung jarak:", err));
                        });
                    }
                    else
                    {
                        clearInterval(timer);
                    }
                }
            },
            error: function (err) {
                $('#ListTask').html('<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>');
            },
            onBeforeSend: function () {
                $('#ListTask').html(`
                <div class="p-3 mb-2 border rounded shadow-sm">
                    <div class="d-flex align-items-center mb-2">
                    <div class="skeleton-icon me-2"></div>
                    <div class="skeleton-text w-50"></div>
                    </div>
                    <div class="skeleton-text w-75 mb-1"></div>
                    <div class="skeleton-text w-25"></div>
                </div>`);

            },
        });
    }


    function SampaiDiLokasi(id) {
        Swal.fire({
            title: 'üìç Sudah sampai di lokasi?',
            text: "Pastikan kamu benar-benar sudah tiba sebelum melanjutkan.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‚úÖ Ya, saya sudah sampai!',
            cancelButtonText: 'Batal',
            customClass: {
                popup: 'rounded-4 shadow-lg',
                title: 'fw-bold text-primary',
                confirmButton: 'btn btn-success rounded-pill px-4 py-2 ms-2',
                cancelButton: 'btn btn-outline-secondary rounded-pill px-4 py-2 ms-2 mt-2'
            },
            buttonsStyling: false,
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                var user = getUserInfo();
                var Data = {
                    Id: id,
                    MitraId: user.id
                };
                callApi({
                    url: '/api/Task/SampaiDiLokasi',
                    method: 'POST',
                    data: Data,
                    success: function (res) {
                        Swal.fire({
                            title: '‚úÖ Lokasi dikonfirmasi!',
                            text: 'Status task berhasil diperbarui.',
                            icon: 'success',
                            showConfirmButton: true,
                            confirmButtonText: 'Lanjutkan',
                            customClass: {
                                popup: 'rounded-4 shadow-lg',
                                title: 'fw-bold text-success',
                                confirmButton: 'btn btn-primary px-4 py-2 rounded-pill',
                            },
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            LoadListTask(hari,status);
                        });
                    },
                    error: function (err) {
                        Swal.fire({
                            title: '‚ùå Gagal memperbarui status',
                            text: err,
                            icon: 'error',
                            confirmButtonText: 'Tutup',
                            customClass: {
                                confirmButton: 'btn btn-danger rounded-pill px-4 py-2'
                            },
                            buttonsStyling: false
                        });
                    },
                    onBeforeSend: function () {
                        $("#btnBerangkat" + id).prop("disabled", true).html('<i class="bi bi-hourglass-split me-1"></i>Memproses...');
                    },
                    onComplete: function () {
                        $("#btnBerangkat" + id).prop("disabled", false).html('Sudah Sampai');
                    }
                });
            }
        });
    }

    function MulaiPengerjaan(id){
        startCamera(id);
    }

    function InspeksiUnit(id){
        $("#ShowBarcodeUnitBaru").modal("show");
    }

    function TaskStart(id,id_pelanggan){
        let _UserId = Storage.get('userId');
        
        var Data = {
            Id : id,
            MitraId : _UserId
        }
        //console.log(Data);

        callApi({
            url: '/api/Task/Berangkat',
            method: 'POST',
            data: Data,
            success: function (res) {
                //console.log(res);
                if(res){
                    callUpdateStatusPadaPelanggan(id_pelanggan,"teknisi sedang dalam perjalanan");
                    $("#ModalDalamPerjalanan").attr("data-id", id); // simpan id ke attribute modal    
                    $("#ModalDalamPerjalanan").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
                    $("#ModalDalamPerjalanan").modal("show");
                    LoadListTask(hari,status);
                }
                else
                {
                    showToast(res.message);
                }
            },
            error: function (err) {
                //alert("Gagal: " + err);
                $("#btnStart"+id).prop("disabled", false).text("Mulai");
            },
            onBeforeSend: function () {
                $("#btnStart"+id).prop("disabled", true).text("Memproses...");
            },
            onComplete: function () {
                $("#btnStart"+id).prop("disabled", false).text("Mulai");
            }
        });

    }

    function showProcess(id,status,id_pelanggan){
        //console.log(id);
        if(status == 5){
            $("#ModalDalamPerjalanan").attr("data-id", id); // simpan id ke attribute modal    
            $("#ModalDalamPerjalanan").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ModalDalamPerjalanan").modal("show");
        }
        else if(status == 6){
            $("#ShowCamera").attr("data-id", id); // simpan id ke attribute modal    
            $("#ShowCamera").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ShowCamera").modal("show");
        }
        else if(status == 7){
            $("#ModalPengerjaanPhoto").attr("data-id", id);
            $("#ModalPengerjaanPhoto").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ModalPengerjaanPhoto").modal("show");
        }
        else if(status == 8){
            $("#ModalPengecekanAkhir").attr("data-id", id);
            $("#ModalPengecekanAkhir").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ModalPengecekanAkhir").modal("show");   
        }
        else if(status == 9){
            $("#ModalVerifikasiPekerjaan").attr("data-id", id);
            $("#ModalVerifikasiPekerjaan").attr("data-id_pelanggan", id_pelanggan); // simpan id ke attribute modal    
            $("#ModalVerifikasiPekerjaan").modal("show");   
        }
    }

</script>