@{
    ViewData["Title"] = "Home Page";
}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .hover-shadow:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08) !important;
        transition: box-shadow 0.3s ease-in-out;
    }

    .card-footer .overflow-auto::-webkit-scrollbar {
        height: 6px;
    }

    .card-footer .overflow-auto::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
</style>
<style>
    /* Animasi shimmer */
    @@keyframes skeleton-loading {
    0% {
        background-position: -200px 0;
    }
    100% {
        background-position: 200px 0;
    }
    }

    /* Base skeleton style */
    .skeleton-text,
    .skeleton-icon {
    background: linear-gradient(90deg, #e0e0e0 25%, #f2f2f2 50%, #e0e0e0 75%);
    background-size: 400% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
    }

    .skeleton-text {
    height: 14px;
    }

    .skeleton-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    }
</style>

@await Html.PartialAsync("_ModalPengerjaan")
@await Html.PartialAsync("_ModalDalamPerjalanan")
@await Html.PartialAsync("_ModalShowCamera")

<div class="app-body pb-30">    
    <div class="container" style="margin-top:10px;margin-bottom :10px;">
        <p>List Perkerjaan <span id="txtFiltered"></span></p>
        <div class="owl-carousel" id="jadwalCarousel" style="margin-top:10px;margin-bottom:10px;">
            <!-- Hari Ini -->
            <div class="item">
                <button id="btnHariIni" 
                        class="btn btn-sm w-100 rounded-pill"
                        onclick="LoadListTask(0);"
                        style="background: #007bff; color:#fff;">
                    <i class="bi bi-calendar-day me-1"></i> Hari Ini
                </button>
            </div>
            <!-- Besok -->
            <div class="item">
                <button id="btnHariBesok" 
                        class="btn btn-sm w-100 rounded-pill"
                        onclick="LoadListTask(1);"
                        style="background: #ffc107; color:#000;">
                    <i class="bi bi-calendar-check me-1"></i> Besok
                </button>
            </div>
            <!-- Jauh Hari -->
            <div class="item">
                <button id="btnHariJauh" 
                        class="btn btn-sm w-100 rounded-pill"
                        onclick="LoadListTask(2);"
                        style="background: #28a745; color:#fff;">
                    <i class="bi bi-calendar-range me-1"></i> Jauh Hari
                </button>
            </div>
        </div>

        
        <div id="ListTask">
                        <!-- Item Skeleton -->
            <div class="p-3 mb-2 border rounded shadow-sm">
                <div class="d-flex align-items-center mb-2">
                <div class="skeleton-icon me-2"></div>
                <div class="skeleton-text w-50"></div>
                </div>
                <div class="skeleton-text w-75 mb-1"></div>
                <div class="skeleton-text w-25"></div>
            </div>

            <!-- Item Skeleton -->
            <div class="p-3 mb-2 border rounded shadow-sm">
                <div class="d-flex align-items-center mb-2">
                <div class="skeleton-icon me-2"></div>
                <div class="skeleton-text w-50"></div>
                </div>
                <div class="skeleton-text w-75 mb-1"></div>
                <div class="skeleton-text w-25"></div>
            </div>
            <!-- Item Skeleton -->
            <div class="p-3 mb-2 border rounded shadow-sm">
                <div class="d-flex align-items-center mb-2">
                <div class="skeleton-icon me-2"></div>
                <div class="skeleton-text w-50"></div>
                </div>
                <div class="skeleton-text w-75 mb-1"></div>
                <div class="skeleton-text w-25"></div>
            </div>
            <!-- Item Skeleton -->
            <div class="p-3 mb-2 border rounded shadow-sm">
                <div class="d-flex align-items-center mb-2">
                <div class="skeleton-icon me-2"></div>
                <div class="skeleton-text w-50"></div>
                </div>
                <div class="skeleton-text w-75 mb-1"></div>
                <div class="skeleton-text w-25"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let hari = 0;
    var $;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.jQuery === 'undefined') {
            console.error('jQuery is not loaded.');
            return;
        }
        $ = window.jQuery;
        Storage.set("CurrentPage","");
        
        loadHeader();
        checkStatusMitra().then(result => {
            if (result.data.status_mitra == 5) 
            {
                LoadListTask(0);
                initFilter();
            }
            else{
                Swal.fire({
                    title: "Akun Belum Aktif",
                    text: "Akun Mitra Anda belum aktif sepenuhnya. Silakan ikuti langkah aktivasi terlebih dahulu.",
                    icon: "info",
                    confirmButtonColor: "#198754",
                    confirmButtonText: "Ikuti Aktivasi",
                    timer: 6000,
                    timerProgressBar: true
                }).then(() => {
                    window.location.href = '@Url.Action("Index","Home")';
                });
            }
        });
    });

    function initFilter() {
        $('#jadwalCarousel').owlCarousel({
            loop: false,
            margin: 2,
            nav: false,
            responsive: {
                0: { items: 3 },
                600: { items: 3 },
                1000: { items: 3 }
            }
        });
    }

    function LoadListTask(hari){
        let _UserId = Storage.get('userId');
        callApi({
            url: '/api/Task/GetTask?Id='+_UserId+'&Hari='+hari,
            method: 'GET',
            success: function (data) {
                console.log(data);
                var html = "";
                if (!data || data.length === 0) {
                    html = '<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>';
                    $('#ListTask').html(html);
                }
                else {
                    
                    html = $.map(data, function (item) {
                        var tglKunjung = "";
                        var jamKunjung = "";
                        if(item.jenis_layanan=="REG"){
                            tglKunjung = item.kunjungan.reguler.tanggal;
                            jamKunjung = item.kunjungan.reguler.jam;
                        }

                        let no_plgn = item.kontak_pelanggan.nomor.replace("+", "");
                        let btnAction ="";
                        
                        btnAction = btnAction + `
                            <!-- Tombol Aksi -->
                            <button onclick="DetailPesanan(289,'btnDetail289');"
                                    class="btn btn-sm btn-primary rounded-pill px-3">
                                    Detail <i class="bi bi-arrow-right-short"></i>
                            </button>
                        `;

                        let alertDurasi = "";
                        if(item.status == 3)
                        {
                            alertDurasi = `
                                <div class="alert alert-warning small py-2 mb-2 rounded-3 d-none" id="SLA_${item.id}">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                    Sesuai waktu kunjungan dan estimasi perjalanan, kemungkinan kamu akan <b>terlambat</b>.
                                    Segera hubungi pelanggan untuk konfirmasi keterlambatan.
                                </div> 
                            `;
                        }

                        if(item.status == 4 && hari == 0){
                            btnAction = btnAction + `
                                <button onclick="TaskStart(${item.id});" id="btnStart${item.id}"
                                        class="btn btn-sm btn-success rounded-pill px-3">
                                        Mulai <i class="bi bi-arrow-right-short"></i>
                                </button>
                            
                            `;
                        }

                        if(item.status > 4 && hari == 0){
                            btnAction = btnAction + `
                                <button onclick="showProcess(${item.id},${item.status});" id="btnProses${item.id}"
                                        class="btn btn-sm btn-success rounded-pill px-3">
                                        On Progres<i class="bi bi-arrow-right-short"></i>
                                </button>
                            `;
                        }
                       
                        var src = `
                            <div class="card mb-3 border-0 shadow rounded-4 order-card">
                                <div class="card-body p-3">
                                    <!-- Header -->
                                    ${alertDurasi}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="fw-bold text-primary mb-0">ACD-${formatToSixDigits(item.id)}</h6>
                                        <span class="badge bg-light text-primary border">
                                            ${item.kategori_layanan} - ${item.jenis_layanan}
                                        </span>
                                    </div>

                                    <!-- Info Grid -->
                                    <div class="row g-2 small">
                                        <!-- Customer -->
                                        <div class="col-8 d-flex align-items-center">
                                            <i class="bi bi-calendar-event me-1 text-primary"></i>
                                            <span><strong>${formatTanggal(tglKunjung)}</strong> - <strong>${jamKunjung}</strong></span>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span class="text-success text-decoration-none" id="count_${item.id}">--</span>
                                        </div>
                                        <!-- Customer -->
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="bi bi-person-circle text-secondary me-2"></i>
                                            <span class="fw-semibold">${item.kontak_pelanggan.nama}</span>
                                        </div>
                                        <div class="col-6 text-end">
                                            <a href="https://wa.me/${no_plgn}" target="_blank" class="text-success text-decoration-none">
                                                <i class="bi bi-whatsapp me-1"></i>Chat
                                            </a>
                                        </div>

                                        <!-- Lokasi -->
                                        <div class="col-8 d-flex align-items-center flex-wrap">
                                            <!-- Jenis Properti -->
                                            <div class="d-flex align-items-center me-3 mb-1">
                                                <i class="bi bi-house-door-fill text-danger me-1"></i>
                                                <span class="fw-semibold">${item.jenis_properti.nama_jenis}</span>
                                            </div>

                                            <!-- Alamat -->
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="text-muted">${item.alamat_pelanggan.alamat}</span>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <a href="#" target="_blank" class="text-success text-decoration-none"
                                                onclick="showMaps('${item.alamat_pelanggan.koordinat}')"
                                            >
                                                <i class="bi bi-geo me-1"></i>maps
                                            </a>
                                        </div>

                                        <!-- Jarak & Fee -->
                                        <div class="col-6 d-flex align-items-center small text-secondary">
                                            <!-- Jarak -->
                                            <div class="d-flex align-items-center me-3">
                                                <i class="bi bi-signpost text-primary me-1"></i>
                                                <span id="jarak_${item.id}" class="fw-semibold text-dark">--</span>
                                            </div>

                                            <!-- Durasi -->
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-stopwatch text-success me-1"></i>
                                                <span id="durasi_${item.id}" class="fw-semibold text-dark">--</span>
                                            </div>
                                        </div>
                                        <div class="col-6 text-end fw-semibold text-success">
                                            ${formatRupiah(item.fee_teknisi)}
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 mt-3">
                                        ${btnAction}
                                    </div>
                                </div>
                            </div>
                        `;
                        return src;
                    }).join('');
                        
                    $('#ListTask').html(html);

                    // setelah DOM sudah jadi baru panggil countdown & jarak
                    if(data.length > 0){
                        data.forEach(item => {
                            let jamKunjung = item.kunjungan?.reguler?.jam ?? null;
                            if(jamKunjung) {
                                startCountdown(item.id,jamKunjung,"count_"+item.id);
                            }

                            hitungJarakJalan(item.origin, item.tujuan)
                            .then(res => {
                                $("#jarak_"+item.id).text(res.distance);
                                $("#durasi_"+item.id).text(res.duration);
                            })
                            .catch(err => console.error("Gagal hitung jarak:", err));
                        });
                    }
                    else
                    {
                        clearInterval(timer);
                    }
                }
            },
            error: function (err) {
                $('#ListTask').html('<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>');
            },
            onBeforeSend: function () {

            },
        });
    }

    function LoadListTaskV1(filterHari) {
        var selectedHari = "";
        if (filterHari == 0) { selectedHari = "Hari ini" }
        else if (filterHari == 1) { selectedHari = "Besok" }
        else if (filterHari == 2) { selectedHari = "Jauh Hari" }
        $("#txtFiltered").text(selectedHari);
        hari = filterHari;
        var user = getUserInfo();
        callApi({
            url: '/api/Task/GetTask?Id=' + user.id + '&Hari=' + filterHari,
            method: 'GET',
            success: function (data) {
                var html = "";

                if (!data || data.length === 0) {
                    html = '<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>';
                    $('#ListBid').html(html);
                }
                else {

                    console.log(data);
                    html = $.map(data, function (item) {
                        var scr = "";
                        var dtPesanan = '';
                        item.Pesanan.forEach(p => {
                            dtPesanan = dtPesanan +
                                `
                                    <li>
                                        ${p.nama} &times; ${p.jumlah}
                                        <span class="text-muted">(${formatRupiah(p.total)})</span>
                                    </li>
                                `
                                ;
                        });

                        var btnAction = "";
                        if (item.status_order == 4) {
                            btnAction = `
                                <button 
                                id="btnBerangkat${item.id}"
                                class="btn btn-sm btn-danger w-100" onclick="BerangkatKeLokasi(${item.id})">
                                <i class="bi bi-check-circle me-1"></i> Berangkat Ke Lokasi
                                </button>
                            `;
                        }
                        else if (item.status_order == 5) {
                            btnAction = `
                            <button class="btn btn-sm btn-success w-100" onclick="SampaiDiLokasi(${item.id})">
                                <i class="bi bi-check-circle me-1"></i> Sudah Sampai Lokasi
                            </button>
                            `;
                        }
                        else if (item.status_order == 6) {
                            btnAction = `
                            <button class="btn btn-sm btn-success w-100" onclick="InspeksiUnit(${item.id})">
                            <i class="bi bi-check-circle me-1"></i> Inspeksi Unit
                            </button>
                            `;
                        }
                        else if (item.status_order == 7) {
                            btnAction = `
                            <button class="btn btn-sm btn-outline-danger w-100" onclick="MulaiPengerjaan(${item.id})">
                            <i class="bi bi-check-circle me-1"></i> Mulai Pengerjaan
                            </button>
                            `;
                        }



                        scr = `
                        <div class="card mb-3 position-relative shadow-sm border-0 hover-shadow">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start position-relative">
                                    <div>
                                        <h5 class="card-title mb-1 fw-bold">
                                            ID: 
                                            <span class="text-primary">
                                            ACD - ${formatToSixDigits(item.id)}
                                            </span>
                                        </h5>
                                        

                                        <div class="mt-3">
                                            <h6 class="fw-bold mb-2">Layanan:</h6>
                                            <ul class="mb-0 ps-0" style="list-style-type:disc;font-size:small;">
                                                ${dtPesanan}
                                            </ul>
                                        </div>
                                        <div class="mt-4">
                                            <h6 class="fw-bold mb-2">Customer:</h6>
                                            <ul class="list-unstyled small text-body-secondary">
                                                <li class="mb-1">
                                                <i class="bi bi-person-fill me-1 text-dark"></i>
                                                <strong>${item.nama}</strong> 
                                                <span class="text-muted">(${item.whatsapp})</span>
                                                </li>
                                                <li class="mb-1">
                                                <i class="bi bi-geo-alt-fill me-1 text-dark"></i>
                                                ${item.alamat}
                                                </li>
                                                <li>
                                                <i class="bi bi-calendar-event me-1 text-dark"></i>
                                                ${item.tanggal_kunjungan} 
                                                <span class="ms-1">
                                                    <i class="bi bi-clock me-1"></i>${item.jam_kunjungan}
                                                </span>
                                                </li>
                                            </ul>
                                        </div>
                                        <p class="card-text mb-0 mt-3">
                                            Total Pesanan: 
                                            <span class="fw-semibold text-success">
                                                ${formatRupiah(item.total)}
                                            </span>
                                        </p>
                                    </div>
                                    <!-- Tombol WhatsApp dan Maps dalam satu baris -->
                                    <div class="d-flex flex-column align-items-end gap-2 ms-3">
                                        <button 
                                            id="btnWhatsapp${item.id}"
                                            onclick="CallWhatapp(${item.id});"
                                            class="btn btn-success btn-sm"
                                            title="Hubungi via WhatsApp"
                                            style="border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-whatsapp"></i>
                                        </button>
                                        <button 
                                            id="btnMaps${item.id}"
                                            onclick="ShowMaps(${item.id});"
                                            class="btn btn-danger btn-sm"
                                            title="Lihat Maps"
                                            style="border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-geo-alt"></i>
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <div class="card-footer bg-light border-top-0">
                                <div class="d-flex flex-nowrap overflow-auto py-1" style="gap: 0.5rem;">
                                ${btnAction}
                                </div>
                            </div>
                        </div>
                        `;
                        return scr;
                    }).join('');
                    $('#ListBid').html(html);

                }
            },
            error: function (err) {
                $('#ListBid').html('<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>');

            },
            onBeforeSend: function () {
                $('#ListBid').html('<p class="text-center text-muted py-4">sedang memuat data.....</p>');
            },
        });
    }

    function BerangkatKeLokasi(id) {
        Swal.fire({
            title: '🎯 Yakin ingin berangkat sekarang?',
            text: "Tindakan ini tidak bisa dibatalkan.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '🚗 Ya, berangkat!',
            cancelButtonText: 'Batal',
            customClass: {
                popup: 'rounded-4 shadow-lg',
                title: 'fw-bold text-warning',
                confirmButton: 'btn btn-success rounded-pill px-4 py-2',
                cancelButton: 'btn btn-secondary rounded-pill px-4 py-2 ms-2'
            },
            buttonsStyling: false,
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                var user = getUserInfo();
                var Data = {
                    Id: id,
                    MitraId: user.id
                };

                callApi({
                    url: '/api/Task/BerangkatKeLokasi',
                    method: 'POST',
                    data: Data,
                    success: function (res) {
                        Swal.fire({
                            title: '✅ Task diperbarui!',
                            text: 'Kamu berhasil berangkat ke lokasi.',
                            icon: 'success',
                            confirmButtonText: 'Oke, lanjutkan',
                            customClass: {
                                popup: 'rounded-4 shadow-lg',
                                title: 'fw-bold text-success',
                                confirmButton: 'btn btn-primary px-4 py-2 rounded-pill'
                            },
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            LoadListTask(hari);
                        });
                    },
                    error: function (err) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Gagal memperbarui task: ' + err
                        });
                    },
                    onBeforeSend: function () {
                        $("#btnBerangkat" + id).prop("disabled", true).html('<i class="bi bi-hourglass-split me-1"></i>Memproses...');
                    },
                    onComplete: function () {
                        $("#btnBerangkat" + id).prop("disabled", false).html('Berangkat');
                    }
                });
            }
        });
    }

    function SampaiDiLokasi(id) {
        Swal.fire({
            title: '📍 Sudah sampai di lokasi?',
            text: "Pastikan kamu benar-benar sudah tiba sebelum melanjutkan.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '✅ Ya, saya sudah sampai!',
            cancelButtonText: 'Batal',
            customClass: {
                popup: 'rounded-4 shadow-lg',
                title: 'fw-bold text-primary',
                confirmButton: 'btn btn-success rounded-pill px-4 py-2 ms-2',
                cancelButton: 'btn btn-outline-secondary rounded-pill px-4 py-2 ms-2 mt-2'
            },
            buttonsStyling: false,
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                var user = getUserInfo();
                var Data = {
                    Id: id,
                    MitraId: user.id
                };
                callApi({
                    url: '/api/Task/SampaiDiLokasi',
                    method: 'POST',
                    data: Data,
                    success: function (res) {
                        Swal.fire({
                            title: '✅ Lokasi dikonfirmasi!',
                            text: 'Status task berhasil diperbarui.',
                            icon: 'success',
                            showConfirmButton: true,
                            confirmButtonText: 'Lanjutkan',
                            customClass: {
                                popup: 'rounded-4 shadow-lg',
                                title: 'fw-bold text-success',
                                confirmButton: 'btn btn-primary px-4 py-2 rounded-pill',
                            },
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            LoadListTask(hari);
                        });
                    },
                    error: function (err) {
                        Swal.fire({
                            title: '❌ Gagal memperbarui status',
                            text: err,
                            icon: 'error',
                            confirmButtonText: 'Tutup',
                            customClass: {
                                confirmButton: 'btn btn-danger rounded-pill px-4 py-2'
                            },
                            buttonsStyling: false
                        });
                    },
                    onBeforeSend: function () {
                        $("#btnBerangkat" + id).prop("disabled", true).html('<i class="bi bi-hourglass-split me-1"></i>Memproses...');
                    },
                    onComplete: function () {
                        $("#btnBerangkat" + id).prop("disabled", false).html('Sudah Sampai');
                    }
                });
            }
        });
    }

    function MulaiPengerjaan(id){
        startCamera(id);
    }

    function InspeksiUnit(id){
        $("#ShowBarcodeUnitBaru").modal("show");
    }

    function TaskStart(id){
        let _UserId = Storage.get('userId');
        
        var Data = {
            Id : id,
            MitraId : _UserId
        }
        console.log(Data);

        callApi({
            url: '/api/Task/Berangkat',
            method: 'POST',
            data: Data,
            success: function (res) {
                console.log(res);
                LoadListTask(0);
                $("#ModalMulaiBerangkat").modal("show");
            },
            error: function (err) {
                //alert("Gagal: " + err);
                $("#btnStart"+id).prop("disabled", false).text("Mulai");
            },
            onBeforeSend: function () {
                $("#btnStart"+id).prop("disabled", true).text("Memproses...");
            },
            onComplete: function () {
                $("#btnStart"+id).prop("disabled", false).text("Mulai");
            }
        });

    }

    function showProcess(id,status){
        console.log(id);
        if(status == 5){
            $("#ModalDalamPerjalanan").attr("data-id", id); // simpan id ke attribute modal    
            $("#ModalDalamPerjalanan").modal("show");
        }
        else if(status == 6){
            $("#ShowCamera").attr("data-id", id); // simpan id ke attribute modal    
            $("#ShowCamera").modal("show");
        }
        else if(status == 7){
            $("#ModalPengerjaan").attr("data-id", id);
            $("#ModalPengerjaan").modal("show");
        }
    }

</script>