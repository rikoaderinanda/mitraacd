@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

@{
    
    ViewData["Title"] = "Home Page";
    var baseApiUrl = Configuration["AppConfig:BaseApiUrl"];
}
<script>
    // Variabel global yang dapat diakses oleh semua skrip
    const BASE_API_URL = '@baseApiUrl';
</script>
<style>
    body {
        background-color: #f9fafb;
        font-family: 'Inter', sans-serif;
    }
    .hover-shadow:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08) !important;
        transition: box-shadow 0.3s ease-in-out;
    }

    /* Animasi shimmer */
    @@keyframes skeleton-loading {
    0% {
        background-position: -200px 0;
    }
    100% {
        background-position: 200px 0;
    }
    }

    /* Base skeleton style */
    .skeleton-text,
    .skeleton-icon {
    background: linear-gradient(90deg, #e0e0e0 25%, #f2f2f2 50%, #e0e0e0 75%);
    background-size: 400% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
    }

    .skeleton-text {
    height: 14px;
    }

    .skeleton-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    }
</style>

@await Html.PartialAsync("_ModalRegistrasi")
@await Html.PartialAsync("_ModalSkill")
@await Html.PartialAsync("_ModalCoverageArea")
@await Html.PartialAsync("_ModalInterview")
@await Html.PartialAsync("_ModalOnboarding")

<div class="app-body pb-30">
    <div class="container mt-20 mb-30">
        @await Html.PartialAsync("_Greeting_Location")
        @await Html.PartialAsync("_StatusPendaftaranMitra")
        <div id="PanelBidOrder" class="d-none">
            <!-- Informasi Coverage Area -->
            <!-- Coverage Area Info -->
            <div class="d-flex justify-content-between align-items-center px-2 py-2 mb-2" 
                style="background:#f9fbfd; border:1px solid #eaeaea; border-radius:8px; font-size: 13px;">
            <span class="text-muted">
                Orderan ditampilkan sesuai radius coverage anda
            </span>
            <button class="btn btn-link btn-sm text-primary p-0 m-0" style="font-size: 13px;"
                onclick="showCoverageArea()"
            >
                <i class="bi bi-geo-alt me-1"></i> Ubah
            </button>
            </div>

            <!-- Filter Multi Select -->
            <div class="d-flex align-items-center justify-content-between px-1 py-2 bg-light">
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm rounded-pill dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    🔍 Filter Layanan
                    </button>
                    <ul class="dropdown-menu p-2" id="filterLayananMenu" style="min-width: 200px;">
                    <li>
                        <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="all" id="filterAll" onchange="toggleAllFilters(this)">
                        <label class="form-check-label fw-semibold" for="filterAll">Pilih Semua</label>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <div class="form-check">
                        <input class="form-check-input filter-item" type="checkbox" value="cuci" id="filterCuci" onchange="filterOrders()">
                        <label class="form-check-label" for="filterCuci">Cuci AC</label>
                        </div>
                    </li>
                    <li>
                        <div class="form-check">
                        <input class="form-check-input filter-item" type="checkbox" value="perbaikan" id="filterPerbaikan" onchange="filterOrders()">
                        <label class="form-check-label" for="filterPerbaikan">Perbaikan</label>
                        </div>
                    </li>
                    <li>
                        <div class="form-check">
                        <input class="form-check-input filter-item" type="checkbox" value="instalasi" id="filterInstalasi" onchange="filterOrders()">
                        <label class="form-check-label" for="filterInstalasi">Instalasi</label>
                        </div>
                    </li>
                    </ul>
                </div>
            </div>

            <div class="py-2" id="ListBid">
                <!-- Skeleton Loading -->
                <div id="ListBid">
                <!-- Item Skeleton -->
                <div class="p-3 mb-2 border rounded shadow-sm">
                    <div class="d-flex align-items-center mb-2">
                    <div class="skeleton-icon me-2"></div>
                    <div class="skeleton-text w-50"></div>
                    </div>
                    <div class="skeleton-text w-75 mb-1"></div>
                    <div class="skeleton-text w-25"></div>
                </div>
            </div>
        <div>        
    </div>
</div>

<script>
    var $;
    let refreshTimer = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.jQuery === 'undefined') {
            console.error('jQuery is not loaded.');
            return;
        }
        $ = window.jQuery;
        Storage.set("CurrentPage","");
        loadHeader();
        checkStatusMitra().then(result => {
            console.log(result);
            if (result?.data?.status_mitra == 5) 
            {
                $("#statusAktifasiMitra").addClass("d-none");
                $("#PanelBidOrder").removeClass("d-none");
                
                LoadListBid();
                setInterval(() => {
                    LoadListBid();
                }, 60000);
            }
            else{
                $("#PanelBidOrder").addClass("d-none");
                LoadStatusDaftar(result?.data?.status_mitra??0);
            }
        });
    });

    function showCoverageArea(){
        $("#ModalCoverageArea").modal("show");
    }
    
    // Toggle accordion
    function toggleDetail(orderId) {
        const $accordion = $(`#accordion_${orderId}`);
        if ($accordion.is(":visible")) {
            $accordion.slideUp();
        } else {
            // jika mau satu-satu terbuka
            $(".accordion-detail").slideUp();
            $accordion.slideDown();
        }
    }
    // Render cart_item ke HTML
    function renderCartItem(item) {
        const jenis = item.jenis_layanan;
        let html = "";

        if (jenis === "REG") {
            const cart = item.cart_item || {};
            const regulers = Array.isArray(cart.reguler) ? cart.reguler : [];
            const members = Array.isArray(cart.member) ? cart.member : [];
            const allItems = [...regulers, ...members];

            if (allItems.length === 0) return `<span class="text-muted" style="font-size:0.75rem;">-</span>`;

            html += `<div style="display:flex; flex-direction:column; gap:3px; font-size:0.75rem;">`;
            allItems.forEach(i => {
                const harga = new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(i.harga || 0);
                html += `
                    <div style="display:flex; justify-content:space-between; color:#333;">
                        <span style="font-weight:600;">${i.nama.replace(/^Biaya\s+/, '')}</span>
                        <span>Qty: ${i.qty || 0}</span>
                    </div>
                `;
            });
            html += `</div>`;

        } else if (jenis === "MEMBER") {
            const paket = item.paket_member;
            if (!paket) return `<span class="text-muted" style="font-size:0.75rem;">-</span>`;
            const total = new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(paket.total || 0);

            html += `
                <div style="display:flex; flex-direction:column; gap:2px; font-size:0.75rem; color:#333;">
                    <div style="font-weight:600;">${paket.nama_paket}</div>
                    <div>Layanan: ${paket.nama_layanan || "-"}</div>
                    <div>Qty: ${paket.qty || 0}, Total: ${total}, Diskon: ${paket.diskon || 0}%</div>
                    <div>Periode: ${paket.periode || "-"}</div>
                </div>
            `;
        } else {
            html = `<span class="text-muted" style="font-size:0.75rem;">-</span>`;
        }

        return html;
    }

    function renderKeluhanPerbaikan(item) {
        const keluhan = item.keluhan_perbaikan || [];
        if (keluhan.length === 0) return `<span class="text-muted">-</span>`;

        let html = `<div style="display:flex; flex-direction:column; gap:2px; font-size:0.85rem; color:#d9534f;">`;
        keluhan.forEach(k => {
            html += `<div>- ${k.jeniskeluhan}</div>`;
        });
        html += `</div>`;

        return html;
    }

    function LoadListBid(){
        let _UserId = Storage.get('userId');
        callApi({
            url: '/api/Biding/GetBid?Id='+_UserId,
            method: 'GET',
            success: function (data) {
                console.log(data);
                var html = "";
                if (!data || data.length === 0) {
                    html = `
                        <div class="text-center py-5">
                            <div class="d-flex justify-content-center mb-3">
                                <!-- Icon ilustrasi -->
                                <div style="width: 100px; height: 100px; background: #e8f4ff; border-radius: 50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                <i class="bi bi-wind" style="font-size: 2.5rem; color:#0d6efd;"></i>
                                </div>
                            </div>
                            <h5 class="fw-semibold text-primary">Belum ada orderan AC</h5>
                            <p class="text-muted mb-3">
                                Semua orderan service AC dari customer akan tampil di sini.<br>
                                Silakan tunggu sampai ada orderan masuk.
                            </p>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="LoadListBid()">
                                <i class="bi bi-arrow-repeat me-2"></i> Refresh Orderan
                            </button>
                        </div>

                    `;
                    $('#ListBid').html(html);
                }
                else {
                    
                    html = $.map(data, function (item) {
                        var tglKunjung = "";
                        var jamKunjung = "";
                        if(item.jenis_layanan=="REG"){
                            tglKunjung = item.kunjungan.reguler.tanggal;
                            jamKunjung = item.kunjungan.reguler.jam;
                        }

                        let no_plgn = item.kontak_pelanggan.nomor.replace("+", "");
                        let jarak = "";
                        let durasi = "";
                        hitungJarakJalan(item.origin, item.tujuan)
                        .then(res => {
                            jarak = res.distance;
                            durasi = res.duration;
                            $("#jarak_"+item.id).text(jarak);
                            $("#durasi_"+item.id).text(durasi);
                            
                        })
                        .catch(err => console.error("Gagal hitung jarak:", err));
                        var src = `
                            <div class="card mb-3 border-0 shadow rounded-4 order-card">
                                <div class="card-body p-3">
                                <!-- Header -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="fw-bold text-primary mb-0">ACD-${formatToSixDigits(item.id)}</h6>
                                    <span class="badge bg-light text-primary border">
                                        ${item.kategori_layanan} - ${item.jenis_layanan}
                                    </span>
                                </div>

                                <!-- Info Grid -->
                                <div class="row g-2 small">
                                    <!-- Customer -->
                                    <div class="col-12 d-flex align-items-center">
                                        <i class="bi bi-calendar-event me-1 text-primary"></i>
                                        <span><strong>${formatTanggal(tglKunjung)}</strong> - <strong>${jamKunjung}</strong></span>
                                    </div>
                                    <!-- Customer -->
                                    <div class="col-6 d-flex align-items-center">
                                        <i class="bi bi-person-circle text-secondary me-2"></i>
                                        <span class="fw-semibold">${item.kontak_pelanggan.nama}</span>
                                    </div>
                                    <div class="col-6 text-end">
                                        <a href="https://wa.me/${no_plgn}" target="_blank" class="text-success text-decoration-none">
                                            <i class="bi bi-whatsapp me-1"></i>Chat
                                        </a>
                                    </div>

                                    <!-- Lokasi -->
                                    <div class="col-8 d-flex align-items-center flex-wrap">
                                        <!-- Jenis Properti -->
                                        <div class="d-flex align-items-center me-3 mb-1">
                                            <i class="bi bi-house-door-fill text-danger me-1"></i>
                                            <span class="fw-semibold">${item.jenis_properti.nama_jenis}</span>
                                        </div>

                                        <!-- Alamat -->
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="text-muted">${item.alamat_pelanggan.alamat}</span>
                                        </div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <a href="#" target="_blank" class="text-success text-decoration-none"
                                            onclick="showMaps('${item.alamat_pelanggan.koordinat}')"
                                        >
                                            <i class="bi bi-geo me-1"></i>maps
                                        </a>
                                    </div>

                                    <!-- Jarak & Fee -->
                                    <div class="col-6 d-flex align-items-center small text-secondary">
                                        <!-- Jarak -->
                                        <div class="d-flex align-items-center me-3">
                                            <i class="bi bi-signpost text-primary me-1"></i>
                                            <span id="jarak_${item.id}" class="fw-semibold text-dark">--</span>
                                        </div>

                                        <!-- Durasi -->
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-stopwatch text-success me-1"></i>
                                            <span id="durasi_${item.id}" class="fw-semibold text-dark">--</span>
                                        </div>
                                    </div>
                                    <div class="col-6 text-end fw-semibold text-success">
                                        ${formatRupiah(item.fee_teknisi)}
                                    </div>
                                </div>

                                    <!-- Tombol Aksi -->
                                    <div class="d-flex justify-content-end gap-2 mt-3">
                                        <!-- Tombol Detail -->
                                        <button class="btn btn-sm btn-primary rounded-pill px-3 d-flex align-items-center" onclick="toggleDetail(${item.id})">
                                            Detail <i class="bi bi-arrow-down-short ms-1"></i>
                                        </button>

                                        <!-- Tombol Ambil -->
                                        <button onclick="BidOrder(${item.id},${item.id_pelanggan});" id="btnBid${item.id}"
                                                class="btn btn-sm btn-success rounded-pill px-3 d-flex align-items-center">
                                            Ambil <i class="bi bi-arrow-right-short ms-1"></i>
                                        </button>
                                    </div>

                                    <!-- Accordion Detail -->
                                    <div class="accordion-detail mt-2" 
                                        id="accordion_${item.id}" style="display:none; border-top:1px dashed #ddd; padding-top:8px;"
                                        >
                                        <div>
                                            <p>Detail Transaksi:</p>
                                            ${renderCartItem(item)}
                                        </div>
                                        <div class="mt-2">
                                            <p>Keluhan Perbaikan:</p>
                                            ${renderKeluhanPerbaikan(item)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        return src;
                    }).join('');
                        
                    $('#ListBid').html(html);

                }
            },
            error: function (err) {
                $('#ListBid').html('<p class="text-center text-muted py-4">Belum ada pesanan yang disimpan.</p>');
            },
            onBeforeSend: function () {
                $('#ListBid').html(`
                <div class="p-3 mb-2 border rounded shadow-sm">
                    <div class="d-flex align-items-center mb-2">
                    <div class="skeleton-icon me-2"></div>
                    <div class="skeleton-text w-50"></div>
                    </div>
                    <div class="skeleton-text w-75 mb-1"></div>
                    <div class="skeleton-text w-25"></div>
                </div>`);

            },
        });
    }

    function BidOrder(id,id_pelanggan){
        let _UserId = Storage.get('userId');
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
            //console.log("Auto-refresh dihentikan.");
        }

        var Data = {
            Id : id,
            MitraId : _UserId
        }
        //console.log(Data);

        callApi({
            url: '/api/Biding/Takeit',
            method: 'POST',
            data: Data,
            success: function (res) {
                //console.log(res);
                if(res){
                    showToast("Berhasil mengambil orderan, silakan cek di menu 'Task' untuk melihat detailnya.");
                    callUpdateStatusPadaPelanggan(id_pelanggan,"Mitra telah mengambil orderan Anda. Mitra akan segera menghubungi Anda via WhatsApp untuk konfirmasi lebih lanjut.");
                    LoadListBid();
                    setInterval(() => {
                        LoadListBid();
                    }, 60000);
                }
                else
                {
                    showToast(res.message);
                }
            },
            error: function (err) {
                alert("Gagal: " + err);
            },
            onBeforeSend: function () {
                $("#btnBid"+id).prop("disabled", true).text("Memproses...");
            },
            onComplete: function () {
                $("#btnBid"+id).prop("disabled", false).text("Memproses...");
            }
        });

    }


    // Fungsi disable modal step yang sudah selesai
    function disableStepModal(stepId) {
        const item = document.getElementById(stepId).closest(".step-item");
        item.removeAttribute("data-bs-toggle");
        item.style.cursor = "not-allowed";
        item.style.opacity = "0.6";
    }

    // Fungsi blokir klik step di atas step aktif
    function blockStep(stepId) {
        const item = document.getElementById(stepId).closest(".step-item");
        item.removeAttribute("data-bs-toggle");
        item.style.cursor = "not-allowed";
        item.setAttribute("onclick", "showToast('Kamu harus menyelesaikan langkah yang sedang berjalan dulu sebelum bisa lanjut 🚀');");
    }
    
    function LoadStatusDaftar(status){
        $("#statusAktifasiMitra").removeClass("d-none");
        // 0 = Biodata, 1 = Skill, 2 = Coverage, 3 = Interview, 4 = Onboarding, 5 = Selesai
        
        const steps = ["stepBiodata", "stepSkill", "stepCoverage", "stepInterview", "stepOnboarding"];
        const progressLine = document.getElementById("progressLine");

        // Reset step
        steps.forEach((id, index) => {
            const el = document.getElementById(id);
            el.classList.remove("active", "done");
            el.textContent = index + 1; // reset angka
            const item = el.closest(".step-item");
            item.setAttribute("data-bs-toggle","modal"); // reset default
            item.removeAttribute("onclick");
            item.style.cursor = "pointer";
            item.style.opacity = "1";
        });

        // Atur status
        if(status == 0){
            document.getElementById("stepBiodata").classList.add("active");
            progressLine.style.height = "0";

            // Step lain di atas aktif → blokir
            steps.slice(1).forEach(id => blockStep(id));
        }
        else if(status == 1){
            document.getElementById("stepBiodata").classList.add("done");
            document.getElementById("stepBiodata").innerHTML = "✓";
            disableStepModal("stepBiodata");

            document.getElementById("stepSkill").classList.add("active");
            progressLine.style.height = "20%";

            steps.slice(2).forEach(id => blockStep(id));
        }
        else if(status == 2){
            ["stepBiodata","stepSkill"].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add("done");
                el.innerHTML = "✓";
                disableStepModal(id);
            });

            document.getElementById("stepCoverage").classList.add("active");
            progressLine.style.height = "40%";

            steps.slice(3).forEach(id => blockStep(id));
        }
        else if(status == 3){
            ["stepBiodata","stepSkill","stepCoverage"].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add("done");
                el.innerHTML = "✓";
                disableStepModal(id);
            });

            document.getElementById("stepInterview").classList.add("active");
            progressLine.style.height = "60%";

            steps.slice(4).forEach(id => blockStep(id));
        }
        else if(status == 4){
            ["stepBiodata","stepSkill","stepCoverage","stepInterview"].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add("done");
                el.innerHTML = "✓";
                disableStepModal(id);
            });

            document.getElementById("stepOnboarding").classList.add("active");
            progressLine.style.height = "80%";
            }
            else {
            steps.forEach(id => {
                const el = document.getElementById(id);
                el.classList.add("done");
                el.innerHTML = "✓";
                disableStepModal(id); // semua step disable
            });
            progressLine.style.height = "100%";
        }
    }

    function filterOrders() {
        let selected = Array.from(document.querySelectorAll(".filter-item:checked")).map(cb => cb.value);
        let orders = document.querySelectorAll(".order-card");

        if (selected.length === 0) {
            orders.forEach(card => card.style.display = "block"); // default: tampil semua
            return;
        }

        orders.forEach(card => {
            if (selected.includes(card.dataset.layanan)) {
            card.style.display = "block";
            } else {
            card.style.display = "none";
            }
        });
    }

    // toggle semua filter
    function toggleAllFilters(allCheckbox) {
        let items = document.querySelectorAll(".filter-item");
        items.forEach(cb => cb.checked = allCheckbox.checked);
        filterOrders();
    }

    
</script>

