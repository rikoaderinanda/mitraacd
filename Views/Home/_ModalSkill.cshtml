<div class="modal fade" id="ModalSkill" tabindex="-1" aria-labelledby="ModalSkillLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 border-0">
      <div class="home-cart mt-0">
        <div class="row">
          <!-- Header -->
          <div class="col-12">
            <div class="login-top position-relative text-center bg-primary text-white p-4 rounded-top-4">
              <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
              <img src="https://cdn-icons-png.flaticon.com/512/2922/2922510.png" 
                   alt="Skill Illustration" 
                   class="img-fluid mb-3" 
                   style="max-height:40px;">
              <h5 class="fs-4 fw-bold mb-2">Skill Mitra</h5>
              <p class="fs-7 mb-0 opacity-75 text-white">
                Kami membutuhkan beberapa keterangan skill Anda, sobat.
              </p>
            </div>
          </div>

          <!-- Body -->
          <div class="col-12">
            <div class="login-bottom p-4">
              <div id="skillWizard">
                
                <!-- Step 1: Skill Utama -->
                <div class="wizard-step" id="skillStep1">
                  <h5 class="fw-bold mb-3 text-primary">üõ† Pilih Skill Utama</h5>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="instalasi" id="instalasi">
                    <label class="form-check-label" for="instalasi">Instalasi AC</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="perawatan" id="perawatan">
                    <label class="form-check-label" for="perawatan">Perawatan / Servis AC</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="perbaikan" id="perbaikan">
                    <label class="form-check-label" for="perbaikan">Perbaikan AC</label>
                  </div>

                  <!-- Sub-skill perbaikan -->
                  <div class="ms-4 mt-2 d-none" id="perbaikanDetail">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="kebocoran" id="kebocoran">
                      <label class="form-check-label" for="kebocoran">Perbaikan Kebocoran Pipa / Freon</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="kompresor" id="kompresor">
                      <label class="form-check-label" for="kompresor">Perbaikan / Penggantian Kompresor</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="blower" id="blower">
                      <label class="form-check-label" for="blower">Perbaikan Blower / Fan Indoor-Outdoor</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="kelistrikan" id="kelistrikan">
                      <label class="form-check-label" for="kelistrikan">Perbaikan Kelistrikan AC</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sparepart" id="sparepart">
                      <label class="form-check-label" for="sparepart">Penggantian Sparepart (kapasitor, motor, dll)</label>
                    </div>
                  </div>

                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="bongkarPasang" id="bongkarPasang">
                    <label class="form-check-label" for="bongkarPasang">Bongkar & Pasang AC</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="isiFreon" id="isiFreon">
                    <label class="form-check-label" for="isiFreon">Pengisian Freon</label>
                  </div>

                  <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary rounded-pill px-4" onclick="validasiStep1()">Lanjut ‚û°</button>
                  </div>
                </div>

                <!-- Step 2: Lama + Deskripsi -->
                <div class="wizard-step d-none" id="skillStep2">
                  <h5 class="fw-bold mb-3 text-primary">üìÖ Lama & Deskripsi Pengalaman</h5>
                  
                  <div class="form-floating mb-3">
                    <input type="number" 
                          class="form-control rounded-3" 
                          id="lamaPengalaman" 
                          placeholder="Contoh: 3" 
                          min="0" 
                          max="99" 
                          oninput="if(this.value.length > 2) this.value = this.value.slice(0,2);">
                    <label for="lamaPengalaman">Lama Pengalaman (Tahun)</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control rounded-3"
                              id="deskripsiSkill"
                              placeholder="Jelaskan pengalaman Anda"
                              style="height: 120px;"></textarea>
                    <label for="deskripsiSkill">Deskripsi Skill / Pengalaman</label>
                  </div>
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevSkillStep(1)">‚¨Ö Kembali</button>
                    <button class="btn btn-primary rounded-pill px-4" onclick="validasiStep2()">Lanjut ‚û°</button>
                  </div>
                </div>

                <!-- Step 3: Sertifikasi -->
                <div class="wizard-step d-none" id="skillStep3">
                  <h5 class="fw-bold mb-3 text-primary">üéì Sertifikasi</h5>
                  <div class="form-text mb-3">
                    Format: JPG, PNG, atau PDF. Maksimal 2MB. 
                    <br><span class="text-muted fst-italic">Tidak memiliki sertifikat? Abaikan bagian ini, Anda tetap bisa melanjutkan.</span>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-3" id="sertifikasi" placeholder="Contoh: Sertifikat BNSP Teknisi AC">
                    <label for="sertifikasi">Nama Sertifikasi (Opsional)</label>
                  </div>
                  <div class="mb-3">
                    <label for="fileSertifikat" class="form-label fw-semibold">Upload Sertifikat</label>
                    <input class="form-control rounded-3" type="file" id="fileSertifikat" accept=".jpg,.jpeg,.png,.pdf">
                    <div class="form-text">Format: JPG, PNG, atau PDF. Maksimal 2MB.</div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="prevSkillStep(2)">‚¨Ö Kembali</button>
                    <button class="btn btn-success rounded-pill px-4" onclick="simpanSkill()">üíæ Simpan Skill</button>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>

  // Object global untuk simpan data skill
  let dataSkill = {
    skills: [],
    lamaPengalaman: null,
    deskripsi: "",
    sertifikasi: null,
    fileSertifikat: null
  };
  
  const perbaikanCheckbox = document.getElementById("perbaikan");
  const perbaikanDetail = document.getElementById("perbaikanDetail");

  document.addEventListener("DOMContentLoaded", function () {
    // Step pertama tampil saat modal muncul
    $("#ModalSkill").on("shown.bs.modal", function () {
      $(".wizard-step").addClass("d-none");
      $("#skillStep1").removeClass("d-none");
    });
  });

  // Tampilkan / sembunyikan sub-skill
  perbaikanCheckbox.addEventListener("change", function () {
    if (this.checked) {
      perbaikanDetail.classList.remove("d-none");
    } else {
      perbaikanDetail.classList.add("d-none");
      perbaikanDetail.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
    }
  });

  function nextSkillStep(step) {
    $(".wizard-step").addClass("d-none");
    $("#skillStep" + step).removeClass("d-none");
  }
  function prevSkillStep(step) {
    $(".wizard-step").addClass("d-none");
    $("#skillStep" + step).removeClass("d-none");
  }
  

function validasiStep1() {
  let selectedSkills = [];

  // Skill utama
  const skillUtama = [
    "instalasi",
    "perawatan",
    "perbaikan",
    "bongkarPasang",
    "isiFreon"
  ];

  skillUtama.forEach(id => {
    let checkbox = document.getElementById(id);
    if (checkbox && checkbox.checked) {
      // Kalau perbaikan, cek juga sub-skill
      if (id === "perbaikan") {
        let subSkills = [];
        document
          .querySelectorAll("#perbaikanDetail input[type=checkbox]:checked")
          .forEach(cb => {
            subSkills.push(cb.value);
          });

        if (subSkills.length === 0) {
          Swal.fire({
            icon: "warning",
            title: "Sub-skill diperlukan",
            text: "Kalau memilih Perbaikan, pilih minimal 1 jenis perbaikan yang bisa kamu lakukan."
          });
          return;
        }

        selectedSkills.push({ skill: id, subSkills: subSkills });
      } else {
        selectedSkills.push({ skill: id });
      }
    }
  });

  if (selectedSkills.length === 0) {
    Swal.fire({
      icon: "warning",
      title: "Oops!",
      text: "Pilih minimal 1 skill utama dulu ya üëç"
    });
    return;
  }

  // Simpan ke object global
  dataSkill.skills = selectedSkills;

  console.log("Skill yang dipilih:", dataSkill);

  // Lanjut ke step berikutnya
  nextSkillStep(2);
}

function validasiStep2() {
  let lama = document.getElementById("lamaPengalaman").value.trim();
  let deskripsi = document.getElementById("deskripsiSkill").value.trim();

  // Validasi lama pengalaman
  if (!lama || isNaN(lama) || parseInt(lama) <= 0) {
    Swal.fire({
      icon: "warning",
      title: "Oops!",
      text: "Isi lama pengalaman dengan angka lebih dari 0 ya üëç"
    });
    return;
  }

  // Validasi deskripsi
  if (deskripsi.length < 10) {
    Swal.fire({
      icon: "warning",
      title: "Deskripsi kurang lengkap",
      text: "Tolong isi deskripsi pengalaman minimal 10 karakter."
    });
    return;
  }

  // Simpan ke object global
  dataSkill.lamaPengalaman = parseInt(lama);
  dataSkill.deskripsi = deskripsi;

  console.log("Data skill step 2:", dataSkill);

  // Lanjut ke step berikutnya
  nextSkillStep(3);
}

function simpanSkill() {
  let sertifikasi = document.getElementById("sertifikasi").value.trim();
  let fileInput = document.getElementById("fileSertifikat");
  let file = fileInput.files[0];

  // Sertifikasi opsional
  dataSkill.sertifikasi = sertifikasi || null;

  // Validasi file sertifikat jika ada
  if (file) {
    let allowedTypes = ["image/jpeg", "image/png", "application/pdf"];
    let maxSize = 2 * 1024 * 1024; // 2MB

    if (!allowedTypes.includes(file.type)) {
      Swal.fire({
        icon: "error",
        title: "Format tidak valid",
        text: "File harus JPG, PNG, atau PDF."
      });
      return;
    }

    if (file.size > maxSize) {
      Swal.fire({
        icon: "error",
        title: "File terlalu besar",
        text: "Ukuran file maksimal 2MB."
      });
      return;
    }

    dataSkill.fileSertifikat = file;
  } else {
    dataSkill.fileSertifikat = null;
  }

  console.log("Data skill lengkap:", dataSkill);
  let _UserId = Storage.get('userId');
  let data = {
    user_id : _UserId,
    skills : dataSkill  
  }

  simpanSkillApi(data)
  .then((res)=>{
      console.log(res);
      if(res.success){
          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Skill berhasil disimpan üöÄ"
          }).then(() => {
            // Tutup modal setelah berhasil
            let modal = bootstrap.Modal.getInstance(document.getElementById("ModalSkill"));
            modal.hide();
            window.location.href = '@Url.Action("Index","Home")';
          });
      }
      else
      {
          showToast(res.message);
      }
  })
  .catch((err) => {
    console.error("Error update Skill :", err);
    showToast("Terjadi kesalahan saat update skill. Coba lagi!");
  });

  
}

function simpanSkillApi(data){
    return new Promise((resolve, reject) => {
        console.log("Mengirim data skill:", data);
        callApi({
            url: '/api/Auth/simpanSkill',
            method: 'POST',
            data: data, // ‚úÖ pakai data dari parameter
            success: function (res) {
                console.log("Respon simpan skill:", res);
                resolve(res);
            },
            error: function (err) {
                console.error("Error simpan skill:", err);
                reject(err);
            },
            onBeforeSend: function () {
                Swal.fire({
                    title: "Update Skill...",
                    text: "Mohon tunggu sebentar.",
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
            },
            onComplete: function () {
                Swal.close();
            }
        });
    });
}
</script>
