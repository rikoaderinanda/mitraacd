
<style>
/* Skeleton effect */
.skeleton-line {
  height: 16px;
  border-radius: 8px;
  background: linear-gradient(90deg, #eee 25%, #ddd 37%, #eee 63%);
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
}

/* spacing helper */
.mb-3 {
  margin-bottom: 1rem;
}

/* shimmer animation */
@@keyframes shimmer {
  0% { background-position: -400px 0; }
  100% { background-position: 400px 0; }
}
</style>
<div class="modal fade" id="ModalInterview" tabindex="-1" aria-labelledby="ModalInterviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 border-0 shadow-lg">
      <div class="home-cart mt-0">
        <div class="row">
          <!-- Header -->
          <div class="col-12">
            <div class="login-top position-relative text-center bg-primary text-white p-4 rounded-top-4">
              <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
              <!-- Ilustrasi -->
              <img src="https://cdn-icons-png.flaticon.com/512/2922/2922510.png" 
                   alt="Interview Illustration" 
                   class="img-fluid mb-3" 
                   style="max-height:40px;">

              <h5 class="fs-4 fw-bold mb-2">Undangan Interview</h5>
              <p class="fs-7 mb-0 opacity-75 text-white">
                Kamu diundang untuk tahap interview sebagai mitra teknisi AC. 
                Silakan pilih konfirmasi kehadiran.
              </p>
            </div>
          </div>
          <!-- Body -->
          <div class="col-12">
            <div class="login-bottom p-4">
              <!-- Skeleton Loader -->
              <div id="panelUndangan"></div>
              <!-- Form Ajuan Reschedule -->
              <div id="formReschedule" class="p-4 d-none">
                <h6 class="fw-bold mb-3">üìù Ajukan Reschedule</h6>

                <div class="mb-3">
                  <label for="rescheduleDate" class="form-label">Tanggal Interview Baru</label>
                  <input type="date" class="form-control rounded-3" id="rescheduleDate">
                </div>

                <div class="mb-3">
                  <label for="rescheduleTime" class="form-label">Jam Interview Baru</label>
                  <input type="time" class="form-control rounded-3" id="rescheduleTime">
                </div>

                <div class="mb-3">
                  <label for="rescheduleReason" class="form-label">Alasan Reschedule</label>
                  <textarea class="form-control rounded-3" id="rescheduleReason" rows="3" placeholder="Tuliskan alasan kamu..."></textarea>
                </div>

                <!-- Aksi -->
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-primary rounded-pill fw-semibold flex-fill" onclick="ajukanReschedule()">
                    üöÄ Kirim Ajuan
                  </button>
                  <button type="button" class="btn btn-outline-secondary rounded-pill fw-semibold" onclick="toggleRescheduleForm(false)">
                    ‚ùå Batal
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>  
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    //checkUndangan();
});

$('#ModalInterview').on('shown.bs.modal', function () {
    
    checkUndangan()
    .then((res)=>{
        var html ="";
        console.log(res.undangan_interview);

        if(!res.undangan_interview)
        {

            html =`
              <div class="mb-3 justify-content-center" id="waitingInvitation">
                  <img src="https://cdn-icons-png.flaticon.com/512/7486/7486742.png" 
                      alt="Waiting Illustration" 
                      class="img-fluid mb-4" 
                      style="max-height:100px;">
                  
                  <!-- Judul -->
                  <h4 class="fw-bold mb-2">Menunggu Undangan Interview</h4>
                  
                  <!-- Deskripsi -->
                  <p class="text-muted mb-4">
                  Kamu sudah mendaftar sebagai mitra teknisi AC.<br>
                  Saat ini kamu sedang menunggu undangan interview dari admin.<br>
                  Notifikasi akan muncul di aplikasi ketika undangan dikirim.
                  </p>

                  <!-- Status -->
                  <div class="alert alert-info rounded-3 fw-semibold">
                  ‚è≥ Status: Menunggu Undangan
                  </div>

                  <!-- Tombol refresh / cek -->
                  <button class="btn btn-primary rounded-3 fw-semibold mt-2" type="button">
                  üîÑ Cek Undangan Terbaru
                  </button>
              </div>
            `;
            //$("#waitingInvitation").removeClass("d-none");
            //$("#InvitationInterview").addClass("d-none");
        }
        else
        {
          if(res.undangan_interview.status ==1){
            html = `
              <div id="InvitationInterview">
                  <div class="mb-3">
                      <label class="form-label fw-semibold">Jadwal Interview:</label>
                      <p class="mb-1">üóìÔ∏è ${res.undangan_interview.hari}, ${formatDate(res.undangan_interview.tanggal)}</p>
                      <p class="mb-0">‚è∞ ${res.undangan_interview.jam} WIB</p>
                  </div>

                 <!-- Mode Interview Offline -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Mode Interview:</label>
                    
                    <div class="p-3 border rounded-3 bg-light">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-building me-2 text-primary"></i>
                        <span class="fw-semibold">${res.undangan_interview.mode}</span>
                      </div>

                      <!-- Alamat Kantor -->
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-geo-alt-fill me-2 text-danger"></i>
                        <div>
                          ${res.undangan_interview.alamat}
                          <br>
                          <a href="${res.undangan_interview.maps}" target="_blank" class="text-decoration-none">
                            <small><i class="bi bi-map me-1"></i> Lihat di Google Maps</small>
                          </a>
                        </div>
                      </div>

                      <!-- Nomor WhatsApp -->
                      <div class="d-flex align-items-center">
                        <i class="bi bi-whatsapp me-2 text-success"></i>
                        <a href="https://wa.me/${res.undangan_interview.no_hp}" target="_blank" class="text-decoration-none">
                          ${formatPhoneNumber(res.undangan_interview.no_hp)}
                        </a>
                      </div>
                    </div>
                  </div>


                  <!-- Aksi -->
                  <div class="d-flex flex-column gap-2">
                    <button class="btn btn-success shadow-sm rounded-pill fw-semibold py-2 px-3" type="button" onclick="">
                      ‚úÖ Konfirmasi Hadir
                    </button>

                    <button class="btn btn-outline-warning shadow-sm rounded-pill fw-semibold py-2 px-3" 
                            type="button" 
                            onclick="toggleRescheduleForm(true)">
                      üîÑ Ajukan Reschedule
                    </button>

                    <button class="btn btn-outline-secondary shadow-sm rounded-pill fw-semibold py-2 px-3" data-bs-dismiss="modal">
                      ‚ùå Batal
                    </button>
                  </div>

              </div>
            `;
          }
          else if(res.undangan_interview.status ==2){
              html = `
                <div class="p-3 rounded-4 shadow-sm bg-white">
                  <!-- Jadwal Interview -->
                  <div class="mb-4">
                    <label class="form-label fw-semibold text-primary">
                      <i class="bi bi-calendar-event me-1"></i> Jadwal Interview
                    </label>
                    <div class="ps-1">
                      <p class="mb-1">üóìÔ∏è <span class="fw-semibold">${res.undangan_interview.hari}, ${formatDate(res.undangan_interview.tanggal)}</span></p>
                      <p class="mb-0">‚è∞ ${res.undangan_interview.jam} WIB</p>
                    </div>
                  </div>

                  <!-- Mode Interview Offline -->
                  <div class="mb-4">
                    <label class="form-label fw-semibold text-primary">
                      <i class="bi bi-building me-1"></i> Mode Interview
                    </label>
                    <div class="p-3 border rounded-3 bg-light">
                      <!-- Mode -->
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-building-check me-2 text-primary"></i>
                        <span class="fw-semibold">${res.undangan_interview.mode}</span>
                      </div>

                      <!-- Alamat -->
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-geo-alt-fill me-2 text-danger fs-5"></i>
                        <div>
                          <span class="fw-medium">${res.undangan_interview.alamat}</span><br>
                          <a href="${res.undangan_interview.maps}" target="_blank" class="text-decoration-none small">
                            <i class="bi bi-map me-1"></i> Lihat di Google Maps
                          </a>
                        </div>
                      </div>

                      <!-- WhatsApp -->
                      <div class="d-flex align-items-center">
                        <i class="bi bi-whatsapp me-2 text-success fs-5"></i>
                        <a href="https://wa.me/${res.undangan_interview.no_hp}" target="_blank" class="text-decoration-none fw-semibold">
                          ${formatPhoneNumber(res.undangan_interview.no_hp)}
                        </a>
                      </div>
                    </div>
                  </div>

                  <!-- Ajuan Reschedule -->
                  <div class="mb-2">
                    <label class="form-label fw-semibold text-warning">
                      <i class="bi bi-arrow-repeat me-1"></i> Ajuan Reschedule
                    </label>
                    <div class="ps-1 border-start border-3 border-warning ps-3">
                      <p class="mb-1">üóìÔ∏è ${formatDate(res.ajuan_reschedule_interview.tanggal)}</p>
                      <p class="mb-1">‚è∞ ${res.ajuan_reschedule_interview.jam} WIB</p>
                      <p class="mb-0 text-muted fst-italic">"${res.ajuan_reschedule_interview.alasan}"</p>
                    </div>
                    <div>
                      <span class="badge bg-info text-dark px-3 py-2">
                        <i class="bi bi-hourglass-split me-1"></i> Proses Ajuan
                      </span>
                    </div>
                  </div>
                </div>

              `;
          }
          else if(res.undangan_interview.status ==3){
            html = `
              <div id="InvitationInterview" class="p-4 rounded-4 shadow-sm bg-white border">
                <!-- Jadwal Interview -->
                <div class="mb-4">
                  <label class="form-label fw-semibold text-primary d-flex align-items-center">
                    <i class="bi bi-calendar-event me-2"></i> Jadwal Interview
                  </label>
                  <div class="ps-1">
                    <p class="mb-1 fs-6">üóìÔ∏è <span class="fw-semibold">${res.undangan_interview.hari}, ${formatDate(res.undangan_interview.tanggal)}</span></p>
                    <p class="mb-0 fs-6">‚è∞ ${res.undangan_interview.jam} WIB</p>
                  </div>
                </div>

                <!-- Mode Interview -->
                <div class="mb-4">
                  <label class="form-label fw-semibold text-primary d-flex align-items-center">
                    <i class="bi bi-building me-2"></i> Mode Interview
                  </label>
                  <div class="p-3 border rounded-3 bg-light">
                    
                    <!-- Mode -->
                    <div class="d-flex align-items-center mb-3">
                      <i class="bi bi-building-check me-2 text-primary fs-5"></i>
                      <span class="fw-semibold">${res.undangan_interview.mode}</span>
                    </div>

                    <!-- Alamat -->
                    <div class="d-flex align-items-start mb-3">
                      <i class="bi bi-geo-alt-fill me-2 text-danger fs-5"></i>
                      <div>
                        <span class="fw-medium">${res.undangan_interview.alamat}</span><br>
                        <a href="${res.undangan_interview.maps}" target="_blank" class="text-decoration-none small">
                          <i class="bi bi-map me-1"></i> Lihat di Google Maps
                        </a>
                      </div>
                    </div>

                    <!-- WhatsApp -->
                    <div class="d-flex align-items-center">
                      <i class="bi bi-whatsapp me-2 text-success fs-5"></i>
                      <a href="https://wa.me/${res.undangan_interview.no_hp}" target="_blank" class="text-decoration-none fw-semibold">
                        ${formatPhoneNumber(res.undangan_interview.no_hp)}
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Status Konfirmasi -->
                <div class="mb-3 text-center">
                  <span class="badge bg-success px-4 py-2 fs-6 rounded-pill shadow-sm">
                    <i class="bi bi-check-circle-fill me-2"></i> Kamu telah konfirmasi hadir
                  </span>
                </div>

                <!-- Catatan Kaki -->
                <div class="alert alert-light border rounded-3 text-muted small mt-4">
                  <i class="bi bi-info-circle me-1 text-primary"></i>
                  Proses akan diupdate secara otomatis sesuai tahapan seleksi yang telah kamu lalui. Terima kasih üôè
                </div>

              </div>

            `;
          }
        }
        $("#panelUndangan").html(html);
    });
    
});

function checkUndangan(){
    return new Promise((resolve, reject) => {
      let _UserId = Storage.get('userId');
      callApi({
        url: '/api/Auth/GetData_account?id='+_UserId,
        method: 'GET',
        success: function (res) {
            resolve(res);
        },
        error: function (err) {
            reject(err);
        },
        onBeforeSend: function () {
            $("#panelUndangan").html(
              `
              <div class="skeleton">
                <div class="skeleton-line w-75 mb-3"></div>
                <div class="skeleton-line w-100 mb-3"></div>
                <div class="skeleton-line w-50"></div>
              </div>
              `
            );
        },
        onComplete: function () {
            //$("#btnSimpan").prop("disabled", false).text("üíæ Simpan");
        }
      });
    });
}

function konfirmHadir(){
    // panggil API
    let data ={
      user_id: Storage.get("userId"),
      status: 3
    }
    callApi({
      url: "/api/Auth/simpan_updateStatus_interview",
      method: "POST",
      data: data,
      success: function(res){
        showToast("‚úÖ Kehadiran berhasil dikonfirmasi!");
        toggleRescheduleForm(false);
        $("#ModalInterview").modal("hide");
      },
      error: function(err){
        alert("‚ùå Gagal mengajukan reschedule");
      }
    });

}

function toggleRescheduleForm(show) {
  if(show){
    $("#formReschedule").removeClass("d-none");
    $("#panelUndangan").addClass("d-none");
  } else {
    $("#formReschedule").addClass("d-none");
    $("#panelUndangan").removeClass("d-none");
    
  }
}

function ajukanReschedule() {
  const tanggal = $("#rescheduleDate").val();
  const jam = $("#rescheduleTime").val();
  const alasan = $("#rescheduleReason").val();

  if(!tanggal || !jam){
    alert("Tanggal dan jam harus diisi!");
    return;
  }

  // contoh payload
  const data = {
    user_id:Storage.get("userId"),
    ajuan_reschedule:{
        tanggal: tanggal,
        jam: jam,
        alasan: alasan
    }
  };

  // panggil API
  callApi({
    url: "/api/Auth/simpan_ajuan_reschedule",
    method: "POST",
    data: data,
    success: function(res){
      showToast("‚úÖ Reschedule berhasil diajukan!");
      toggleRescheduleForm(false);
      $("#ModalInterview").modal("hide");
    },
    error: function(err){
      alert("‚ùå Gagal mengajukan reschedule");
    }
  });
}
</script>

